// ============================================================================
// PRISMA SCHEMA ‚Äî ORDENADO POR M√ìDULOS / FUNCIONALIDADES
// ============================================================================
//
// √çNDICE R√ÅPIDO
// [S0] Configuraci√≥n Prisma (generator / datasource)
// [S1] Cat√°logos/Enums globales b√°sicos
// [S2] Sucursales y Usuarios (core)
// [S3] Productos y Cat√°logos de Producto (precios, historial, im√°genes, thresholds)
// [S4] Inventario / Stock (lotes, ajustes, eliminaciones, vencimientos, historial)
// [S5] Proveedores
// [S6] Clientes y Ventas (venta, pago, detalles, anuladas, garant√≠as, cuotas)
// [S7] Taller / Reparaciones
// [S8] Caja y Finanzas (turnos, movimientos, cuentas, clasificaciones)
// [S9] Saldos y Res√∫menes
// [S10] Requisiciones / Compras / Pedidos
// [S11] Transferencias entre Sucursales
// [S12] Metas y Dep√≥sitos de Cobro
// [S13] Notificaciones
// [S14] Ubicaci√≥n (Departamentos / Municipios)
// [S15] Otros (Sorteos)
// [S16] RECEPCIONES DE COMPRAS
// [S17] COMPRAS A PAGAR
// [S18] NOTIFICACIONES CREDITO VENTA
// [S19] PRORROTEOS

// Nota: No se han cambiado nombres ni propiedades; √∫nicamente se reorden√≥ y
// se a√±adieron comentarios de organizaci√≥n.
// ============================================================================

// ============================================================================
// [S0] CONFIGURACI√ìN PRISMA
// ============================================================================
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// [S1] CAT√ÅLOGOS/ENUMS GLOBALES B√ÅSICOS
// ============================================================================

enum Rol {
  ADMIN
  MANAGER
  VENDEDOR
  SUPER_ADMIN
}

enum TipoSucursal {
  TIENDA
  ALMACEN
  CENTRO_DISTRIBUCION
  TALLER
  OFICINA
}

enum MetodoPago {
  CONTADO // quitar en su momento y cambiar en ventas
  EFECTIVO
  TRANSFERENCIA
  TARJETA
  CHEQUE // banco
  CREDITO // a futuro pero de momento no lo voy a usar
  // NUEVOS
  // DEPOSITO_VENTANILLA // dep√≥sito en ventanilla (usamos flags para distinguir a qui√©n)
  OTRO // opcional no lo uso de momento
}

enum TipoPrecio {
  CREADO_POR_SOLICITUD
  ESTANDAR
}

enum EstadoPrecio {
  APROBADO
  PENDIENTE
  RECHAZADO
}

enum TipoNotificacion {
  SOLICITUD_PRECIO
  TRANSFERENCIA
  VENCIMIENTO
  STOCK_BAJO
  OTRO
  CREDITO_VENTA
}

enum EstadoNotificacion {
  NO_LEIDO
  LEIDO
}

enum EstadoSolicitud {
  PENDIENTE
  APROBADO
  RECHAZADO
}

// ============================================================================
// [S2] SUCURSALES Y USUARIOS (CORE)
// ============================================================================

model Sucursal {
  id                           Int                              @id @default(autoincrement())
  nombre                       String // Nombre de la sucursal
  direccion                    String? // Direcci√≥n f√≠sica de la sucursal
  telefono                     String? // Tel√©fono de contacto
  pbx                          String?
  productos                    Stock[] // Relaci√≥n con el stock de productos de la sucursal
  usuarios                     Usuario[] // Relaci√≥n con los empleados de la sucursal
  creadoEn                     DateTime                         @default(now())
  actualizadoEn                DateTime                         @updatedAt
  tipoSucursal                 TipoSucursal
  estadoOperacion              Boolean                          @default(true) // Activa o inactiva
  Venta                        Venta[]
  TransferenciaProducto        TransferenciaProducto[]          @relation("SucursalOrigen")
  TransferenciaProductoDestino TransferenciaProducto[]          @relation("SucursalDestino") // NUEVA RELACI√ìN
  EntregaStock                 EntregaStock[]
  solicitudesOrigen            SolicitudTransferenciaProducto[] @relation("SucursalOrigenSolicitud")
  solicitudesDestino           SolicitudTransferenciaProducto[] @relation("SucursalDestinoSolicitud")
  EliminacionStock             EliminacionStock[]
  RegistroCaja                 RegistroCaja[]

  saldosDiarios           SucursalSaldoDiario[]
  VentaEliminada          VentaEliminada[]
  VentaCuota              VentaCuota[]
  PlantillaComprobante    PlantillaComprobante[]
  Reparacion              Reparacion[]
  MetaUsuario             MetaUsuario[]
  MetaCobros              MetaCobros[]
  DepositoCobro           DepositoCobro[]
  requisiciones           Requisicion[]
  resumenesVenta          ResumenVenta[]
  HistorialStock          HistorialStock[]
  HistorialPrecioCosto    HistorialPrecioCosto[]
  garantias               Garantia[]
  compras                 Compra[]
  pedidos                 Pedido[]
  movimientosFinancieros  MovimientoFinanciero[]
  stockPresentaciones     StockPresentacion[]     @relation("SucursalToStockPresentacion")
  //relaciones con peticiones credito
  solicitudesCreditoVenta SolicitudCreditoVenta[] @relation("SucursalToSolicitudCreditoVenta")
  abonosCredito           AbonoCredito[]          @relation("Sucursal_AbonosCredito") // <‚Äî backref

  prorrateos Prorrateo[] @relation("SucursalToProrrateos")
}

model Usuario {
  id                    Int                     @id @default(autoincrement())
  nombre                String
  rol                   Rol // Rol del usuario
  contrasena            String
  activo                Boolean                 @default(true)
  entregasRecibidas     EntregaStock[]          @relation("UsuarioRecibido")
  correo                String                  @unique
  sucursalId            Int // Relaci√≥n con la sucursal
  sucursal              Sucursal                @relation(fields: [sucursalId], references: [id], onDelete: Cascade)
  TransferenciaProducto TransferenciaProducto[]
  PrecioProducto        PrecioProducto[]
  solicitudesPrecio     SolicitudPrecio[]       @relation("SolicitadoPor")
  solicitudesAprobadas  SolicitudPrecio[]       @relation("AprobadoPor")

  solicitudesEnviadas               SolicitudTransferenciaProducto[] @relation("UsuarioSolicitante")
  solicitudesAprobadasTransferencia SolicitudTransferenciaProducto[] @relation("AdministradorAprobador") // Renombrada para especificidad
  HistorialPrecioCosto              HistorialPrecioCosto[]
  AjusteStock                       AjusteStock[]
  EliminacionProducto               EliminacionProducto[]
  EliminacionCliente                EliminacionCliente[]
  EliminacionStock                  EliminacionStock[]
  Garantia                          Garantia[]
  regitrosGarantiaTimeline          RegistroGarantia[]
  fecha_creacion                    DateTime                         @default(now()) // Aplica un valor por defecto a filas nuevas y existentes
  fecha_actualizacion               DateTime                         @default(now()) // Esto asigna autom√°ticamente la fecha actual.
  VentaEliminada                    VentaEliminada[]
  ventas                            Venta[] // Ventas realizadas por el usuario
  VentaCuota                        VentaCuota[]
  Cuota                             Cuota[]
  Reparacion                        Reparacion[]
  RegistroReparacion                RegistroReparacion[]
  MetaUsuario                       MetaUsuario[]
  MetaCobros                        MetaCobros[]
  DepositoCobro                     DepositoCobro[]
  requisiciones                     Requisicion[]
  resumenesVenta                    ResumenVenta[]
  //tracker movimientos
  movimientoStock                   HistorialStock[]
  //tracker de cajas
  cajasIniciadas                    RegistroCaja[]                   @relation("UsuarioInicio")
  cajasCerradas                     RegistroCaja[]                   @relation("UsuarioCierre")

  // recepciones de requisiciones
  recepcionesRequisiciones RequisicionRecepcion[]
  compras                  Compra[]
  pedidos                  Pedido[]
  saldoGlobalSnapshots     SaldoGlobalDiario[]
  movimientosCaja          MovimientoFinanciero[]
  //NUEVOS
  comprasRecepcionadas     CompraRecepcion[]      @relation("UsuarioToCompraRecepciones")

  //relacion con pagos y creditos compras
  cxpDocumentosCreados CxPDocumento[] @relation("CxPDocumentoCreadoPor")

  cxpPagosRegistrados CxPPago[] @relation("CxPPagoRegistradoPor")

  // Quien crea la solicitud de cr√©dito
  solicitudesCreditoVentaSolicitadas SolicitudCreditoVenta[] @relation("CreditoSolicitadoPor")

  // Quien aprueba/rechaza la solicitud
  solicitudesCreditoVentaAprobadas SolicitudCreditoVenta[] @relation("CreditoAprobadoPor")

  // Acciones registradas en el historial (actor)
  solicitudesCreditoVentaHistorialActuados SolicitudCreditoVentaHistorial[] @relation("ActorSolicitudCredito")

  historialCredito        VentaCuotaHistorial[]    @relation("Usuario_HistorialCredito") // <‚Äî backref
  abonosCredito           AbonoCredito[]           @relation("Usuario_AbonosCredito") // <‚Äî backref
  //NOTIFICACIONES
  NotificationPreference  NotificationPreference[]
  // Opuesta a Notificacion.remitente ("NotiRemitente")
  notificacionesEmitidas  Notificacion[]           @relation("NotiRemitente")
  // Opuesta a NotificacionesUsuarios.usuario
  notificacionesRecibidas NotificacionesUsuarios[]

  ventasAnuladas Venta[] @relation(name: "AnuladoPor")

  creditosAsignados  VentaCuota[]   @relation("ResponsableCobroCredito") 

}

// ============================================================================
// [S3] PRODUCTOS Y CAT√ÅLOGOS DE PRODUCTO
// ============================================================================

model Producto {
  id                       Int                              @id @default(autoincrement())
  nombre                   String
  descripcion              String?
  stock                    Stock[] // Relaci√≥n con Stock
  categorias               Categoria[]                      @relation(name: "CategoriaToProducto")
  ventas                   VentaProducto[] // Relaci√≥n con productos vendidos en varias ventas
  codigoProducto           String                           @unique // NUEVO A APLICAR
  creadoEn                 DateTime                         @default(now())
  actualizadoEn            DateTime                         @updatedAt
  HistorialStock           HistorialStock[]
  HistorialPrecio          HistorialPrecio[]
  TransferenciaProducto    TransferenciaProducto[]
  //NUEVOS PRECIOS
  precios                  PrecioProducto[] // Relaci√≥n con m√∫ltiples precios
  SolicitudPrecio          SolicitudPrecio[]
  //NUEVA SOLICITUD TRANSFERENCIA
  solicitudesTransferencia SolicitudTransferenciaProducto[]
  //NUEVO PRECIO COSTO PRODUCTO
  precioCostoActual        Float?
  // Historial de precios de costo
  HistorialPrecioCosto     HistorialPrecioCosto[]
  //AJUSTE
  AjusteStock              AjusteStock[]
  EliminacionProducto      EliminacionProducto[]
  EliminacionStock         EliminacionStock[]
  //PARA USARLO EN GARANT√çAS
  Garantia                 Garantia[]
  VentaEliminadaProducto   VentaEliminadaProducto[]
  Reparacion               Reparacion[]
  stockThreshold           StockThreshold? // no array
  codigoProveedor          String?                          @unique
  lineas                   RequisicionLinea[]
  ResumenVenta             ResumenVenta[]
  detallesResumenVenta     DetalleResumenVenta[]
  imagenesProducto         ImagenProducto[]
  //recepciones en requisiciones
  recepcionLineas          RequisicionRecepcionLinea[]
  compraDetalle            CompraDetalle[]
  pedidosLineas            PedidoLinea[]
  //NUEVOS
  unidadBase               String                           @default("unidades") // "ml", "g", "unidades", etc.
  presentaciones           ProductoPresentacion[]
  stockPresentaciones      StockPresentacion[]              @relation("ProductoToStockPresentacion")
  recepcionesCompraLineas  CompraRecepcionLinea[]

  tipoPresentacionId Int?
  tipoPresentacion   TipoPresentacion? @relation(fields: [tipoPresentacionId], references: [id], onDelete: SetNull)

  solicitudesCreditoLineas SolicitudCreditoVentaLinea[] @relation("SolicitudCreditoLineaToProducto")
}

model ProductoPresentacion {
  id           Int      @id @default(autoincrement())
  productoId   Int
  producto     Producto @relation(fields: [productoId], references: [id], onDelete: Cascade)
  nombre       String
  descripcion  String?
  // factorUnidadBase Decimal  @db.Decimal(18, 6)
  // sku              String?  @unique
  codigoBarras String?  @unique

  stockThresholdPresentacion StockThresholdPresentacion?
  imagenesPresentacion       ImagenPresentacion[]

  esDefault           Boolean             @default(false)
  activo              Boolean             @default(true)
  //precios por presentacion
  precios             PrecioProducto[]
  stockPresentaciones StockPresentacion[] @relation("PresentacionToStockPresentacion")

  //relaciones con ventas, requisiciones, pedidos
  ventaProductos    VentaProducto[]
  requisicionLineas RequisicionLinea[] @relation("RequisicionLineaToPresentacion")
  compraDetalles    CompraDetalle[]    @relation("CompraDetalleToPresentacion")
  pedidoLineas      PedidoLinea[]      @relation("PedidoLineaToPresentacion")

  // tipoPresentacion             TipoEmpaque @default(UNIDAD)
  costoReferencialPresentacion Decimal? @db.Decimal(12, 4)

  creadoEn      DateTime @default(now())
  actualizadoEn DateTime @updatedAt

  historialStock          HistorialStock[]
  //NUEVOS
  recepcionesCompraLineas CompraRecepcionLinea[] @relation("PresentacionToCompraRecepcionLinea")
  lineasDocumento         CxPDocumentoLinea[]    @relation("DocumentoLineaToPresentacion")

  solicitudesCreditoLineas SolicitudCreditoVentaLinea[] @relation("SolicitudCreditoLineaToPresentacion")

  tipoPresentacionId Int?
  tipoPresentacion   TipoPresentacion? @relation(fields: [tipoPresentacionId], references: [id], onDelete: SetNull)
  categorias         Categoria[]       @relation(name: "CategoriaToPresentacion")

  @@unique([productoId, nombre])
  @@index([productoId])
  // @@index([sku])
  @@index([codigoBarras])
}

model TipoPresentacion {
  id             Int                    @id @default(autoincrement())
  nombre         String                 @unique // p.ej. "BOTELLA", "CAJA", "BLISTER"
  descripcion    String?
  activo         Boolean                @default(true)
  creadoEn       DateTime               @default(now())
  actualizadoEn  DateTime               @updatedAt
  // Relaci√≥n inversa
  presentaciones ProductoPresentacion[]
  productos      Producto[]
}

model Categoria {
  id             Int                    @id @default(autoincrement())
  nombre         String                 @unique()
  productos      Producto[]             @relation(name: "CategoriaToProducto")
  presentaciones ProductoPresentacion[] @relation(name: "CategoriaToPresentacion")
}

model StockPresentacion {
  id Int @id @default(autoincrement())

  productoId Int
  producto   Producto @relation("ProductoToStockPresentacion", fields: [productoId], references: [id], onDelete: Cascade)

  presentacionId Int
  presentacion   ProductoPresentacion @relation("PresentacionToStockPresentacion", fields: [presentacionId], references: [id], onDelete: Cascade)

  sucursalId Int
  sucursal   Sucursal @relation("SucursalToStockPresentacion", fields: [sucursalId], references: [id], onDelete: Cascade)

  requisicionRecepcionId Int?
  requisicionRecepcion   RequisicionRecepcion? @relation("StockPresentacionRecepcion", fields: [requisicionRecepcionId], references: [id], onDelete: SetNull)

  //historico para cantidad recibida
  cantidadRecibidaInicial Int
  cantidadPresentacion    Int
  // costoUnitarioBase         Decimal   @db.Decimal(12, 4)
  // costoUnitarioPresentacion Decimal?  @db.Decimal(12, 4)
  fechaIngreso            DateTime
  fechaVencimiento        DateTime?
  creadoEn                DateTime              @default(now())
  actualizadoEn           DateTime              @updatedAt
  //NUEVO
  compraRecepcionLinea    CompraRecepcionLinea? @relation("LineaToStockPresentacion")

  compraRecepcionId Int?
  compraRecepcion   CompraRecepcion? @relation("StockPresentacionToCompraRecepcion", fields: [compraRecepcionId], references: [id], onDelete: SetNull)

  // NUEVO: costo por lote de presentaci√≥n
  costoTotal              Float     @default(0)
  precioCosto             Float     @default(0)

  // Back-rel a prorrateo
  prorrateoDetalles       ProrrateoDetalle[] @relation("StockPresToProrrateoDetalles")


  @@index([productoId, sucursalId])
  @@index([presentacionId, sucursalId])
}

model ImagenProducto {
  id         Int      @id @default(autoincrement())
  url        String // ruta o URL de la imagen
  public_id  String? // ID p√∫blico si se usa un servicio de almacenamiento externo  
  altTexto   String? // texto alternativo para accesibilidad
  creadoEn   DateTime @default(now())
  // relaci√≥n inversa
  producto   Producto @relation(fields: [productoId], references: [id])
  productoId Int

  @@index([productoId])
}

model ImagenPresentacion {
  id             Int                  @id @default(autoincrement())
  url            String
  public_id      String?
  altTexto       String?
  orden          Int                  @default(0)
  creadoEn       DateTime             @default(now())
  presentacion   ProductoPresentacion @relation(fields: [presentacionId], references: [id], onDelete: Cascade)
  presentacionId Int

  @@index([presentacionId])
}

model StockThreshold {
  id            Int      @id @default(autoincrement())
  producto      Producto @relation(fields: [productoId], references: [id])
  productoId    Int      @unique // fuerza la relaci√≥n 1:1
  stockMinimo   Int      @default(0)
  creadoEn      DateTime @default(now())
  actualizadoEn DateTime @updatedAt
}

model StockThresholdPresentacion {
  id             Int                  @id @default(autoincrement())
  presentacion   ProductoPresentacion @relation(fields: [presentacionId], references: [id], onDelete: Cascade)
  presentacionId Int                  @unique
  stockMinimo    Int                  @default(0)
  creadoEn       DateTime             @default(now())
  actualizadoEn  DateTime             @updatedAt
}

model SolicitudPrecio {
  id               Int             @id @default(autoincrement())
  productoId       Int
  producto         Producto        @relation(fields: [productoId], references: [id], onDelete: Cascade)
  precioSolicitado Float // Precio solicitado por el vendedor
  solicitadoPorId  Int // Relaci√≥n con el usuario que solicita el precio
  solicitadoPor    Usuario         @relation("SolicitadoPor", fields: [solicitadoPorId], references: [id])
  estado           EstadoSolicitud @default(PENDIENTE) // Estado de la solicitud
  aprobadoPorId    Int? // Admin que aprueba o rechaza la solicitud (nullable)
  aprobadoPor      Usuario?        @relation("AprobadoPor", fields: [aprobadoPorId], references: [id])
  fechaSolicitud   DateTime        @default(now())
  fechaRespuesta   DateTime? // Fecha cuando fue aprobada o rechazada
}

model PrecioProducto {
  id         Int       @id @default(autoincrement())
  productoId Int?
  producto   Producto? @relation(fields: [productoId], references: [id], onDelete: Cascade)

  // NUEVO: si viene, el precio aplica a ESA presentaci√≥n
  presentacionId      Int?
  presentacion        ProductoPresentacion?        @relation(fields: [presentacionId], references: [id], onDelete: Cascade)
  //para persistencia en lineas de credito auth
  lineasSeleccionadas SolicitudCreditoVentaLinea[] @relation("PrecioSeleccionadoEnSolicitudLinea")

  precio        Decimal      @db.Decimal(12, 4)
  creadoPorId   Int?
  creadoPor     Usuario?     @relation(fields: [creadoPorId], references: [id])
  fechaCreacion DateTime     @default(now())
  estado        EstadoPrecio
  usado         Boolean      @default(false)
  tipo          TipoPrecio
  orden         Int
  rol           RolPrecio
  vigenteDesde  DateTime?
  vigenteHasta  DateTime?

  @@index([productoId, presentacionId, estado, orden])
}

enum RolPrecio {
  PUBLICO
  NOVA
  DISTRIBUIDOR
  PROMOCION
}

enum TipoEmpaque {
  CUBETA
  BIDON
  TAMBOR
  BLISTER
  UNIDAD
  BOTELLA
  CAJA
  PACK
  SACO
}

model HistorialPrecio {
  id             Int      @id @default(autoincrement())
  productoId     Int
  producto       Producto @relation(fields: [productoId], references: [id], onDelete: Cascade)
  precioAnterior Float
  precioNuevo    Float
  fechaCambio    DateTime @default(now())
}

model HistorialPrecioCosto {
  id                  Int       @id @default(autoincrement())
  productoId          Int
  precioCostoAnterior Float
  precioCostoNuevo    Float
  fechaCambio         DateTime  @default(now())
  modificadoPorId     Int?
  motivoCambio        String? //nuevo
  sucursalId          Int? //nuevo
  //===RELACIONES===>
  sucursal            Sucursal? @relation(fields: [sucursalId], references: [id], onDelete: Cascade)
  producto            Producto  @relation(fields: [productoId], references: [id], onDelete: Cascade)
  modificadoPor       Usuario?  @relation(fields: [modificadoPorId], references: [id], onDelete: Cascade) // Relaci√≥n con Usuario
}

// ============================================================================
// [S4] INVENTARIO / STOCK
// ============================================================================

model Stock {
  id                     Int                   @id @default(autoincrement())
  productoId             Int
  cantidadInicial        Int? // Cantidad inicial de productos entregados
  cantidad               Int
  costoTotal             Float // Costo total de adquisici√≥n de todos los productos en stock
  creadoEn               DateTime              @default(now())
  actualizadoEn          DateTime              @default(now()) @updatedAt
  fechaIngreso           DateTime
  fechaVencimiento       DateTime? // Fecha de vencimiento asociada al lote de productos
  precioCosto            Float // Precio al que se compr√≥ el producto en ese lote
  producto               Producto              @relation(fields: [productoId], references: [id], onDelete: Cascade)
  entregaStockId         Int? // Puede ser nulo si no est√° relacionado con una entrega espec√≠fica
  entregaStock           EntregaStock?         @relation(fields: [entregaStockId], references: [id], onDelete: SetNull)
  //OTROS
  sucursal               Sucursal              @relation(fields: [sucursalId], references: [id], onDelete: Cascade)
  sucursalId             Int // NUEVO: Relaci√≥n con la sucursal
  Vencimiento            Vencimiento[]
  //AJUSTES DE STOCKS
  AjusteStock            AjusteStock[]
  //relacion con las recepciones de requisiciones
  requisicionRecepcionId Int?
  requisicionRecepcion   RequisicionRecepcion? @relation("StockRecepcion", fields: [requisicionRecepcionId], references: [id], onDelete: SetNull)

  // NUEVO: ancla por recepci√≥n de compra con nombre de relaci√≥n √∫nico
  compraRecepcionId Int?
  compraRecepcion   CompraRecepcion? @relation("StockToCompraRecepcion", fields: [compraRecepcionId], references: [id], onDelete: SetNull)

  // Back-rel de detalles de prorrateo (opuesto de ProrrateoDetalle.stock)
  prorrateoDetalles ProrrateoDetalle[] @relation("StockToProrrateoDetalles")

  compraRecepcionLineas CompraRecepcionLinea[]
}

model EntregaStock {
  id              Int              @id @default(autoincrement())
  proveedorId     Int? // Relaci√≥n opcional con el proveedor
  proveedor       Proveedor?       @relation(fields: [proveedorId], references: [id], onDelete: SetNull)
  montoTotal      Float // Monto total de la entrega (puede ser calculado sumando preciosCosto * cantidad)
  fechaEntrega    DateTime         @default(now())
  stockEntregado  Stock[] // Relaci√≥n con Stock
  recibidoPorId   Int? // Usuario que recibi√≥ la entrega (puede ser opcional)
  usuarioRecibido Usuario?         @relation("UsuarioRecibido", fields: [recibidoPorId], references: [id], onDelete: SetNull)
  //NUEVO
  sucursalId      Int? // NUEVO: Relaci√≥n con la sucursal
  sucursal        Sucursal?        @relation(fields: [sucursalId], references: [id], onDelete: Cascade)
  //tracker
  movimientoStock HistorialStock[]
  // Back-rel: prorrateos aplicados a esta entrega
  prorrateos      Prorrateo[]      @relation("EntregaStockToProrrateos")
}

model HistorialStock {
  id               Int     @id @default(autoincrement())
  cantidadAnterior Int?
  cantidadNueva    Int?
  comentario       String?

  tipo        TipoMovimientoStock
  fechaCambio DateTime            @default(now())

  sucursalId Int?
  sucursal   Sucursal? @relation(fields: [sucursalId], references: [id], onDelete: Cascade)

  usuarioId Int?
  usuario   Usuario? @relation(fields: [usuarioId], references: [id])

  productoId Int?
  producto   Producto? @relation(fields: [productoId], references: [id], onDelete: Cascade)

  // Relaciones a los m√≥dulos que mueven inventario:
  requisicionId Int?
  requisicion   Requisicion? @relation(fields: [requisicionId], references: [id], onDelete: SetNull)

  //rastrear venta
  ventaId                 Int?
  venta                   Venta?                 @relation(fields: [ventaId], references: [id], onDelete: SetNull)
  //rastrear ajuste stock 
  ajusteStockId           Int?
  ajusteStock             AjusteStock?           @relation(fields: [ajusteStockId], references: [id], onDelete: SetNull)
  //rastrear eliminacionStock
  eliminacionStockId      Int?
  eliminacionStock        EliminacionStock?      @relation(fields: [eliminacionStockId], references: [id], onDelete: SetNull)
  //rastrear eliminacion venta
  eliminacionVentaId      Int?
  eliminacionVenta        VentaEliminada?        @relation(fields: [eliminacionVentaId], references: [id], onDelete: SetNull)
  //transferencia de productos
  transferenciaProductoId Int?
  transferenciaProducto   TransferenciaProducto? @relation(fields: [transferenciaProductoId], references: [id], onDelete: SetNull)
  //trackear entregastock
  entregaStockId          Int?
  entregaStock            EntregaStock?          @relation(fields: [entregaStockId], references: [id], onDelete: SetNull)
  //Tracker para garantias aplicadas a un producto
  garantiaId              Int?
  garantia                Garantia?              @relation(fields: [garantiaId], references: [id], onDelete: SetNull)
  //tracker de presentaciones
  presentacionId          Int?
  presentacion            ProductoPresentacion?  @relation(fields: [presentacionId], references: [id], onDelete: SetNull)
}

enum TipoMovimientoStock {
  INGRESO_COMPRA
  INGRESO_REQUISICION
  INGRESO_DEVOLUCION_CLIENTE
  INGRESO_TRANSFERENCIA
  INGRESO_AJUSTE
  SALIDA_VENTA
  AJUSTE_STOCK // nuevo
  ELIMINACION_VENTA // nuevo
  TRANSFERENCIA // NUEVO
  ENTREGA_STOCK // nuevo
  SALIDA_DEVOLUCION_PROVEEDOR
  SALIDA_AJUSTE
  SALIDA_TRANSFERENCIA
  SALIDA_REPARACION
  ELIMINACION
  ELIMINACION_STOCK
  INVENTARIO_INICIAL
  GARANTIA
  OTRO
}

model AjusteStock {
  id               Int              @id @default(autoincrement())
  producto         Producto         @relation(fields: [productoId], references: [id])
  productoId       Int
  stock            Stock?           @relation(fields: [stockId], references: [id]) // Relaci√≥n opcional al stock
  stockId          Int? // Campo opcional para identificar el stock modificado
  cantidadAjustada Int
  tipoAjuste       TipoAjuste
  fechaHora        DateTime         @default(now())
  usuario          Usuario?         @relation(fields: [usuarioId], references: [id])
  usuarioId        Int?
  descripcion      String? // Campo opcional para el motivo del ajuste
  movimientoStock  HistorialStock[]
}

enum TipoAjuste {
  INCREMENTO
  DECREMENTO
  CORRECCION
}

model EliminacionStock {
  id         Int      @id @default(autoincrement())
  productoId Int // Producto asociado al stock eliminado
  producto   Producto @relation(fields: [productoId], references: [id])

  cantidadAnterior       Int? // Stock previo a la eliminaci√≥n
  cantidadStockEliminada Int? // Cantidad que se elimin√≥
  stockRestante          Int? // Stock que qued√≥ despu√©s de la eliminaci√≥n

  fechaHora DateTime @default(now()) // Momento de la eliminaci√≥n

  referenciaTipo String? // Tipo de evento origen ("AJUSTE", "VENCIMIENTO", etc.)
  referenciaId   Int? // ID de la entidad origen para trazabilidad

  motivo String? // Raz√≥n o comentario libre

  usuarioId Int? // Usuario que realiz√≥ la eliminaci√≥n
  usuario   Usuario? @relation(fields: [usuarioId], references: [id])

  sucursalId Int? // Sucursal donde se elimin√≥ el stock
  sucursal   Sucursal? @relation(fields: [sucursalId], references: [id])

  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @default(now()) @updatedAt
  movimientoStock HistorialStock[] // Relaci√≥n con historial de movimientos
}

model EliminacionProducto {
  id         Int      @id @default(autoincrement())
  producto   Producto @relation(fields: [productoId], references: [id])
  productoId Int // Referencia al producto eliminado
  fechaHora  DateTime @default(now())
  usuario    Usuario? @relation(fields: [usuarioId], references: [id])
  usuarioId  Int? // Usuario que realiz√≥ la eliminaci√≥n
  motivo     String? // Raz√≥n de la eliminaci√≥n (opcional)
}

model EliminacionCliente {
  id        Int      @id @default(autoincrement())
  cliente   Cliente  @relation(fields: [clienteId], references: [id])
  clienteId Int // Referencia al cliente eliminado
  fechaHora DateTime @default(now())
  usuario   Usuario? @relation(fields: [usuarioId], references: [id])
  usuarioId Int? // Usuario que realiz√≥ la eliminaci√≥n
  motivo    String? // Raz√≥n de la eliminaci√≥n (opcional)
}

model Vencimiento {
  id               Int               @id @default(autoincrement())
  fechaVencimiento DateTime // Fecha de vencimiento
  estado           EstadoVencimiento @default(PENDIENTE) // Estado del vencimiento (pendiente, notificado, etc.)
  descripcion      String? // Descripci√≥n del vencimiento (opcional)

  // Relaci√≥n con Stock
  stockId       Int? // Relaci√≥n opcional con Stock
  stock         Stock?   @relation(fields: [stockId], references: [id], onDelete: SetNull)
  // No es necesario incluir notificaciones aqu√≠
  fechaCreacion DateTime @default(now()) // Fecha de creaci√≥n de la notificaci√≥n
}

enum EstadoVencimiento {
  PENDIENTE
  NOTIFICADO
  RESUELTO
}

// ============================================================================
// [S5] PROVEEDORES
// ============================================================================

model Proveedor {
  id               Int                    @id @default(autoincrement())
  nombre           String
  correo           String?
  telefono         String?
  direccion        String?
  razonSocial      String?
  rfc              String?
  nombreContacto   String?
  telefonoContacto String?
  emailContacto    String?
  pais             String?
  ciudad           String?
  codigoPostal     String?
  latitud          Float?
  longitud         Float?
  entregasStock    EntregaStock[]
  activo           Boolean                @default(true)
  notas            String?
  creadoEn         DateTime               @default(now())
  actualizadoEn    DateTime               @updatedAt
  //REFERENCIA AL PRIMER TICKET DE GARANTIA
  Garantia         Garantia[]
  //REFERENCIA AL registro final
  compras          Compra[]
  movimientosCaja  MovimientoFinanciero[]
  cxpDocumentos    CxPDocumento[]         @relation("ProveedorToCxPDocumentos")
}

// ============================================================================
// [S6] CLIENTES Y VENTAS (incluye Garant√≠as y Ventas a Cuotas)
// ============================================================================

model Cliente {
  id                 Int                  @id @default(autoincrement())
  nombre             String
  apellidos          String?
  telefono           String?
  direccion          String?
  compras            Venta[]
  observaciones      String?
  creadoEn           DateTime             @default(now())
  actualizadoEn      DateTime             @updatedAt
  municipioId        Int? // EN UBICACION TABLA
  municipio          Municipio?           @relation(fields: [municipioId], references: [id], onDelete: SetNull) // EN UBICACION TABLA
  departamentoId     Int? // EN UBICACION TABLA
  departamento       Departamento?        @relation(fields: [departamentoId], references: [id], onDelete: SetNull) // EN UBICACION TABLA
  EliminacionCliente EliminacionCliente[]
  dpi         String?  @unique
  nit         String?  @unique
  //PARA LAS GARANT√çAS
  Garantia           Garantia[]
  iPInternet         String? //IP PARA ENCONTRAR EL PAGO DE INTERNET
  VentaEliminada   VentaEliminada[]
  VentaCuota       VentaCuota[]
  Reparacion       Reparacion[]
  //SOFT DELETE
  eliminado        Boolean          @default(false) // SOFT DELETE FLAG
  fechaEliminacion DateTime? // Opcional: cu√°ndo fue dado de baja
  pedidos          Pedido[]
  solicitudesCreditoVenta SolicitudCreditoVenta[] @relation("ClienteToSolicitudCreditoVenta")
  @@unique([dpi, id]) // √çndice compuesto que permite m√∫ltiples null en dpi
}

model Venta {
  id                    Int              @id @default(autoincrement())
  clienteId             Int? // Relaci√≥n opcional con un cliente//ENVIAR:OPCIONAL
  cliente               Cliente?         @relation(fields: [clienteId], references: [id], onDelete: SetNull)
  fechaVenta            DateTime         @default(now())
  horaVenta             DateTime         @default(now())
  productos             VentaProducto[] //ENVIAR
  totalVenta            Float // Total de la venta//ENVIAR
  metodoPago            Pago? // Cambia esto para permitir null
  sucursalId            Int // NUEVO: Relaci√≥n con la sucursal que hizo la venta
  sucursal              Sucursal         @relation(fields: [sucursalId], references: [id], onDelete: Cascade)
  nombreClienteFinal    String?
  telefonoClienteFinal  String?
  direccionClienteFinal String?
  imei                  String?
  registroCajaId        Int? // ID del turno de caja al que pertenece la venta
  registroCaja          RegistroCaja?    @relation(fields: [registroCajaId], references: [id], onDelete: SetNull)
  // Relaci√≥n opcional con una VentaCuota
  ventaCuota            VentaCuota?
  //relacion con venta opcional
  usuarioId             Int? // Relaci√≥n con el usuario que realiz√≥ la venta
  usuario               Usuario?         @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  //relacion con el movimiento
  movimientosStock      HistorialStock[]
  //Relaciones con garantias
  garantias             Garantia[]
  referenciaPago        String?          @unique
  tipoComprobante       TipoComprobante  @default(RECIBO)

  solicitudCredito SolicitudCreditoVenta? @relation("SolicitudCreditoVentaToVenta")

  //FLAGS DE ANULACION
  anulada         Boolean   @default(false)
  fechaAnulacion  DateTime?
  motivoAnulacion String?
  anuladaPorId    Int?
  anuladaPor      Usuario?  @relation(name: "AnuladoPor", fields: [anuladaPorId], references: [id], onDelete: SetNull)

  @@unique([imei, id]) // Permite null en `imei` sin conflicto de unicidad 
}

enum TipoComprobante {
  FACTURA
  RECIBO
}

model VentaProducto {
  id          Int                @id @default(autoincrement())
  ventaId     Int
  productoId  Int?
  cantidad    Int
  venta       Venta              @relation(fields: [ventaId], references: [id], onDelete: Cascade)
  producto    Producto?          @relation(fields: [productoId], references: [id], onDelete: SetNull)
  creadoEn    DateTime           @default(now())
  precioVenta Float // Sugerencia: usa Decimal
  estado      EstadoDetalleVenta @default(VENDIDO)

  // Presentaci√≥n (opcional)
  presentacionId Int?
  presentacion   ProductoPresentacion? @relation(fields: [presentacionId], references: [id], onDelete: SetNull)
}

enum EstadoDetalleVenta {
  VENDIDO
  PARCIAL_GARANTIA
  ANULADO
  REEMPLAZADO
  GARANTIA_REPARADO
  REEMBOLSADO
}

model Pago {
  id         Int        @id @default(autoincrement())
  ventaId    Int        @unique // Hacer que cada venta tenga solo un m√©todo de pago
  venta      Venta      @relation(fields: [ventaId], references: [id], onDelete: Cascade)
  monto      Float // Monto pagado
  metodoPago MetodoPago // Usar el enum en lugar de String
  fechaPago  DateTime   @default(now())
}

model VentaEliminada {
  id               Int      @id @default(autoincrement())
  usuarioId        Int // ID del usuario que realiz√≥ la eliminaci√≥n
  usuario          Usuario  @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  motivo           String // Motivo de la eliminaci√≥n
  totalVenta       Float // Total de la venta
  clienteId        Int? // ID del usuario que realiz√≥ la eliminaci√≥n
  cliente          Cliente? @relation(fields: [clienteId], references: [id], onDelete: SetNull)
  fechaEliminacion DateTime @default(now()) // Fecha y hora de la eliminaci√≥n
  sucursalId       Int // ID de la sucursal a la que pertenece la venta eliminada
  sucursal         Sucursal @relation(fields: [sucursalId], references: [id], onDelete: Cascade)

  VentaEliminadaProducto VentaEliminadaProducto[] // Relaci√≥n con los productos de la venta eliminada
  movimientoStock        HistorialStock[]
}

model VentaEliminadaProducto {
  id               Int            @id @default(autoincrement())
  ventaEliminadaId Int // Relaci√≥n con VentaEliminada
  ventaEliminada   VentaEliminada @relation(fields: [ventaEliminadaId], references: [id], onDelete: Cascade)
  productoId       Int? // Relaci√≥n con Producto
  producto         Producto?      @relation(fields: [productoId], references: [id], onDelete: SetNull) // Permite que el producto sea eliminado sin romper la relaci√≥n
  cantidad         Int // Cantidad del producto en la venta
  precioVenta      Float // Precio al que se vendi√≥ el producto
  creadoEn         DateTime       @default(now()) // Fecha de creaci√≥n del registro
}

model Garantia {
  id                  Int                @id @default(autoincrement())
  ventaId             Int // vinculamos con la venta
  venta               Venta              @relation(fields: [ventaId], references: [id], onDelete: Cascade)
  productoId          Int
  producto            Producto           @relation(fields: [productoId], references: [id])
  usuarioIdRecibe     Int?
  usuarioRecibe       Usuario?           @relation(fields: [usuarioIdRecibe], references: [id])
  proveedorId         Int? // opcional
  proveedor           Proveedor?         @relation(fields: [proveedorId], references: [id])
  cantidadDevuelta    Int // cu√°ntas unidades est√° devolviendo
  comentario          String? // breve
  descripcionProblema String // detallada
  fechaRecepcion      DateTime           @default(now())
  estado              EstadoGarantia     @default(RECIBIDO)
  registros           RegistroGarantia[]
  creadoEn            DateTime           @default(now())
  actualizadoEn       DateTime           @updatedAt

  clienteId Int
  cliente   Cliente @relation(fields: [clienteId], references: [id], onDelete: Cascade)

  sucursalId      Int?
  sucursal        Sucursal?        @relation(fields: [sucursalId], references: [id], onDelete: Cascade)
  //Relacion con su tracker
  movimientoStock HistorialStock[]
}

model RegistroGarantia {
  id         Int      @id @default(autoincrement())
  garantiaId Int
  garantia   Garantia @relation(fields: [garantiaId], references: [id], onDelete: Cascade)

  estado             EstadoGarantia
  conclusion         String?
  accionesRealizadas String?

  usuarioId Int?
  usuario   Usuario? @relation(fields: [usuarioId], references: [id], onDelete: Cascade)

  fechaRegistro DateTime @default(now())
  actualizadoEn DateTime @updatedAt
}

// ============================================================================
// [S7] TALLER / REPARACIONES
// ============================================================================

model Reparacion {
  id        Int     @id @default(autoincrement())
  usuarioId Int // ID del usuario que atendi√≥
  usuario   Usuario @relation(fields: [usuarioId], references: [id], onDelete: Cascade)

  sucursalId Int // ID de la sucursal donde se realiza la reparaci√≥n
  sucursal   Sucursal @relation(fields: [sucursalId], references: [id], onDelete: Cascade)

  clienteId Int // Cliente asociado a la reparaci√≥n
  cliente   Cliente @relation(fields: [clienteId], references: [id], onDelete: Cascade)

  productoId Int? // Producto del sistema (opcional)
  producto   Producto? @relation(fields: [productoId], references: [id], onDelete: SetNull)

  productoExterno String? // Nombre o descripci√≥n del producto externo

  problemas     String // Descripci√≥n de los problemas reportados
  observaciones String? // Observaciones adicionales (ej. accesorios entregados)

  fechaRecibido  DateTime         @default(now()) // Fecha en que se recibi√≥ el producto
  fechaEntregado DateTime? // Fecha de entrega del producto reparado
  estado         EstadoReparacion @default(PENDIENTE) // Estado actual de la reparaci√≥n

  registros RegistroReparacion[] // Historial de acciones realizadas sobre la reparaci√≥n

  hojaSolucion  String? // Detalles finales de la soluci√≥n
  creadoEn      DateTime @default(now()) // Fecha de creaci√≥n
  actualizadoEn DateTime @updatedAt // √öltima actualizaci√≥n
}

model RegistroReparacion {
  id           Int        @id @default(autoincrement())
  reparacionId Int // Relaci√≥n con la reparaci√≥n
  reparacion   Reparacion @relation(fields: [reparacionId], references: [id], onDelete: Cascade)

  usuarioId Int // Usuario que realiz√≥ la acci√≥n
  usuario   Usuario @relation(fields: [usuarioId], references: [id], onDelete: Cascade)

  estado             EstadoReparacion // Estado de la reparaci√≥n al momento del registro
  accionesRealizadas String // Descripci√≥n de las acciones realizadas (opcional)
  fechaRegistro      DateTime         @default(now()) // Fecha del registro
  comentarioFinal    String? // Comentario final sobre la reparaci√≥n

  montoPagado Int?
}

enum EstadoReparacion {
  RECIBIDO
  PENDIENTE // El producto est√° registrado pero la reparaci√≥n no ha comenzado
  EN_PROCESO // Reparaci√≥n activa
  ESPERANDO_PIEZAS // Reparaci√≥n pausada por falta de piezas
  REPARADO // Reparaci√≥n finalizada, listo para entrega
  ENTREGADO // Reparaci√≥n completada y producto entregado al cliente
  CANCELADO // Reparaci√≥n cancelada
  NO_REPARABLE // Producto no reparable tras diagn√≥stico
  FINALIZADO
}

// ============================================================================
// [S8] CAJA Y FINANZAS
// ============================================================================

model RegistroCaja {
  id         Int      @id @default(autoincrement())
  sucursalId Int
  sucursal   Sucursal @relation(fields: [sucursalId], references: [id], onDelete: Cascade)

  usuarioInicioId Int
  usuarioInicio   Usuario  @relation("UsuarioInicio", fields: [usuarioInicioId], references: [id])
  usuarioCierreId Int?
  usuarioCierre   Usuario? @relation("UsuarioCierre", fields: [usuarioCierreId], references: [id])

  fechaApertura DateTime  @default(now())
  fechaCierre   DateTime?

  // CHANGED: decimales para dinero
  saldoInicial Decimal  @db.Decimal(14, 2)
  saldoFinal   Decimal? @db.Decimal(14, 2)

  estado          EstadoTurnoCaja @default(ABIERTO)
  comentario      String?
  comentarioFinal String?

  // CHANGED: relaci√≥n con movimientos (ahora ‚Äúfinancieros‚Äù)
  movimientos MovimientoFinanciero[]

  // Opcional: ‚Äúventas‚Äù si ya las relacionas al turno
  venta Venta[]

  // Opcional: fondo fijo proyectado (para sugerir dep√≥sito de cierre)
  fondoFijo Decimal @default(0) @db.Decimal(14, 2)

  // (Puede ser redundante si conf√≠as en los movimientos de cierre)
  depositado Boolean @default(false)

  creadoEn      DateTime       @default(now())
  actualizadoEn DateTime       @updatedAt
  abonosCredito AbonoCredito[] @relation("Caja_AbonosCredito") // <‚Äî backref

  // @@index([sucursalId, estado])
  @@index([sucursalId, estado, fechaCierre])
  @@index([sucursalId, usuarioInicioId, estado, fechaCierre]) // ‚úÖ nuevo
}

enum EstadoTurnoCaja {
  ABIERTO
  CERRADO
  ARQUEO
  AJUSTADO
  ANULADO
}

model MovimientoFinanciero {
  id Int @id @default(autoincrement())

  fecha      DateTime @default(now())
  sucursalId Int
  sucursal   Sucursal @relation(fields: [sucursalId], references: [id], onDelete: Cascade)

  // Si impacta efectivo, DEBE pertenecer a un turno ABIERTO
  registroCajaId Int?
  registroCaja   RegistroCaja? @relation(fields: [registroCajaId], references: [id])

  // Clasificaci√≥n y motivo (vistas Admin)
  clasificacion ClasificacionAdmin
  motivo        MotivoMovimiento

  // Reporte/conciliaci√≥n
  metodoPago MetodoPago?

  // IMPORTANTE: efectos expl√≠citos (positivo o negativo)
  deltaCaja  Decimal @default(0) @db.Decimal(14, 2) // + entra efectivo; - sale efectivo
  deltaBanco Decimal @default(0) @db.Decimal(14, 2) // + entra al banco; - sale del banco

  // Opcional si deltaBanco ‚â† 0
  cuentaBancariaId Int?
  cuentaBancaria   CuentaBancaria? @relation(fields: [cuentaBancariaId], references: [id])

  // Informaci√≥n de negocio
  descripcion String?
  referencia  String?
  conFactura  Boolean? // √∫til para compras/gastos

  // Espec√≠ficos de dep√≥sitos (evita ambig√ºedad solicitada por el cliente)
  esDepositoCierre    Boolean @default(false) // si true => bucket ‚ÄúDep√≥sitos (Cierre)‚Äù
  esDepositoProveedor Boolean @default(false) // si true => bucket ‚ÄúDep√≥sitos a Proveedor‚Äù

  // Proveedor y costos
  proveedorId Int?
  proveedor   Proveedor? @relation(fields: [proveedorId], references: [id])

  gastoOperativoTipo GastoOperativoTipo? // si motivo = GASTO_OPERATIVO
  costoVentaTipo     CostoVentaTipo? // si motivo = COMPRA_MERCADERIA o COSTO_ASOCIADO

  // Inventario (conectar cuando recibamos compras)
  afectaInventario Boolean @default(false)

  // Qui√©n registr√≥
  usuarioId Int
  usuario   Usuario @relation(fields: [usuarioId], references: [id])

  creadoEn          DateTime         @default(now())
  actualizadoEn     DateTime         @updatedAt
  esAsientoVentas   Boolean          @default(false) 
  //nuevo
  comprobanteTipo   ComprobanteTipo?
  comprobanteNumero String?          @db.VarChar(64)
  comprobanteFecha  DateTime?
  comprobanteUrl    String? // foto/pdf del baucher
  //NUEVO
  pagoCxP           CxPPago?         @relation("CxPPagoToMovimiento")

  //RELACIONES CON PRORROTEOS
  // √Åmbito para aplicar prorrateo (uno u otro, opcionales)
  compraId Int?
  compra   Compra? @relation("MF_to_Compra", fields: [compraId], references: [id], onDelete: SetNull)

  compraRecepcionId Int?
  compraRecepcion   CompraRecepcion? @relation("MF_to_CompraRecepcion", fields: [compraRecepcionId], references: [id], onDelete: SetNull)

  compraDetalleId Int?
  compraDetalle   CompraDetalle? @relation("MF_to_CompraDetalle", fields: [compraDetalleId], references: [id], onDelete: SetNull)

  requisicionRecepcionId Int?
  requisicionRecepcion   RequisicionRecepcion? @relation("MF_to_ReqRecepcion", fields: [requisicionRecepcionId], references: [id], onDelete: SetNull)

  // 1:1 con Prorrateo (idempotencia por movimiento)
  prorrateo Prorrateo? @relation("MFToProrrateo")

  @@unique([registroCajaId, referencia], map: "uq_movfin_turno_referencia") // üëà idempotencia por turno
  //CONCILIACION EN REPORTES DE CIERRES CON BOLETAS
  @@unique([cuentaBancariaId, comprobanteTipo, comprobanteNumero], map: "uq_movfin_comprobante")
  @@index([registroCajaId, esAsientoVentas]) // üëà √∫til para consultas
  @@index([sucursalId, fecha])
  @@index([registroCajaId])
  @@index([clasificacion, motivo])
  @@index([esDepositoCierre, esDepositoProveedor])
  @@index([comprobanteTipo, comprobanteNumero], map: "idx_movfin_comprobante_lookup")
}

enum ComprobanteTipo {
  DEPOSITO_BOLETA
  TRANSFERENCIA
  CHEQUE
  TARJETA_VOUCHER
  OTRO
}

enum TipoCuentaBancaria {
  AHORRO
  CORRIENTE
  TARJETA
}

model CuentaBancaria {
  id     Int     @id @default(autoincrement())
  banco  String
  numero String
  alias  String?
  activa Boolean @default(true)

  movimientos   MovimientoFinanciero[]
  tipo          TipoCuentaBancaria     @default(CORRIENTE)
  creadoEn      DateTime               @default(now())
  actualizadoEn DateTime               @updatedAt

  isDeleted   Boolean   @default(false)
  eliminadoEn DateTime? // soft delete

  @@unique([banco, numero])
}

// ¬øD√≥nde impacta la contabilidad de resultados?
enum ClasificacionAdmin {
  INGRESO // Ventas, otros ingresos
  COSTO_VENTA // Mercader√≠a + costos asociados (fletes/encomiendas)
  GASTO_OPERATIVO // Salarios, energ√≠a, log√≠stica, etc.
  TRANSFERENCIA // Movimientos entre Caja y Banco (no resultado)
  AJUSTE // Sobrantes/faltantes/regularizaciones
  CONTRAVENTA // Devoluciones / notas de cr√©dito
}

// Motivo real del movimiento (habla el idioma del negocio)
enum MotivoMovimiento {
  VENTA
  OTRO_INGRESO
  GASTO_OPERATIVO
  COMPRA_MERCADERIA
  COSTO_ASOCIADO // fletes, encomiendas, transporte a tienda
  DEPOSITO_CIERRE // ‚Äúpara no dejar efectivo‚Äù
  DEPOSITO_PROVEEDOR // dep√≥sito en ventanilla/boleta pagado con efectivo
  PAGO_PROVEEDOR_BANCO // pago a proveedor desde banco (sin pasar por caja)
  AJUSTE_SOBRANTE
  AJUSTE_FALTANTE
  DEVOLUCION
  BANCO_A_CAJA //nuevo
  COBRO_CREDITO //nuevo
  PAGO_CREDITO
}

// Subtipos √∫tiles (se pueden volver tablas si el cliente quiere editar)
enum GastoOperativoTipo {
  SALARIO
  ENERGIA
  LOGISTICA
  RENTA
  INTERNET
  PUBLICIDAD
  VIATICOS
  OTROS
}

enum CostoVentaTipo {
  MERCADERIA
  FLETE
  ENCOMIENDA
  TRANSPORTE
  OTROS
}

// ============================================================================
// [S9] SALDOS Y RES√öMENES
// ============================================================================

model SucursalSaldoDiario {
  id         Int      @id @default(autoincrement())
  sucursalId Int
  sucursal   Sucursal @relation(fields: [sucursalId], references: [id], onDelete: Cascade)

  // Normalizar a 00:00:00 del d√≠a
  fecha DateTime

  // Caja (efectivo)
  saldoInicioCaja Decimal @db.Decimal(14, 2)
  ingresosCaja    Decimal @db.Decimal(14, 2)
  egresosCaja     Decimal @db.Decimal(14, 2)
  saldoFinalCaja  Decimal @db.Decimal(14, 2)

  // Banco
  saldoInicioBanco Decimal @db.Decimal(14, 2)
  ingresosBanco    Decimal @db.Decimal(14, 2)
  egresosBanco     Decimal @db.Decimal(14, 2)
  saldoFinalBanco  Decimal @db.Decimal(14, 2)

  globalDiarioId Int?
  globalDiario   SaldoGlobalDiario? @relation("GlobalSaldos", fields: [globalDiarioId], references: [id], onDelete: SetNull)

  creadoEn      DateTime @default(now())
  actualizadoEn DateTime @updatedAt

  @@unique([sucursalId, fecha])
}

model SaldoGlobalDiario {
  id    Int      @id @default(autoincrement())
  fecha DateTime @unique

  // Sumatorias de todas las sucursales
  saldoTotalCaja    Decimal @db.Decimal(14, 2)
  ingresosTotalCaja Decimal @db.Decimal(14, 2)
  egresosTotalCaja  Decimal @db.Decimal(14, 2)

  saldoTotalBanco    Decimal @db.Decimal(14, 2)
  ingresosTotalBanco Decimal @db.Decimal(14, 2)
  egresosTotalBanco  Decimal @db.Decimal(14, 2)

  saldosDiarios SucursalSaldoDiario[] @relation("GlobalSaldos")

  usuarioId Int?
  usuario   Usuario? @relation(fields: [usuarioId], references: [id], onDelete: SetNull)

  creadoEn      DateTime @default(now())
  actualizadoEn DateTime @updatedAt
}

enum ResumenPeriodo {
  DIARIO
  SEMANAL
  MENSUAL
  CUSTOM
}

model ResumenVenta {
  id                  Int            @id @default(autoincrement())
  titulo              String?
  sucursalId          Int? // si quieres por sucursal
  sucursal            Sucursal?      @relation(fields: [sucursalId], references: [id])
  usuarioId           Int?
  usuario             Usuario?       @relation(fields: [usuarioId], references: [id])
  periodo             ResumenPeriodo @default(DIARIO)
  fechaInicio         DateTime // p.ej. para semanal: lunes de la semana
  fechaFin            DateTime // p.ej. semanal: domingo de la semana
  totalVentas         Float // suma de montos
  totalTransacciones  Int // n√∫mero de tickets/facturas
  unidadesVendidas    Int // suma de unidades vendidas
  ticketPromedio      Float? // totalVentas / totalTransacciones
  productoTopId       Int? // producto con m√°s ventas en el per√≠odo
  productoTop         Producto?      @relation(fields: [productoTopId], references: [id])
  cantidadProductoTop Int?
  creadoEn            DateTime       @default(now())
  actualizadoEn       DateTime       @updatedAt

  detalles      DetalleResumenVenta[] // opcional, para desglose por producto
  observaciones String?
}

model DetalleResumenVenta {
  id              Int          @id @default(autoincrement())
  resumenVentaId  Int
  resumenVenta    ResumenVenta @relation(fields: [resumenVentaId], references: [id], onDelete: Cascade)
  productoId      Int
  producto        Producto     @relation(fields: [productoId], references: [id])
  cantidadVendida Int // unidades vendidas de este producto
  montoVenta      Float // total facturado de este producto
}

// ============================================================================
// [S10] REQUISICIONES / COMPRAS / PEDIDOS
// ============================================================================

// --- Requisiciones ---

model Requisicion {
  id                  Int                    @id @default(autoincrement())
  folio               String                 @unique // un identificador legible (p. ej. ‚ÄúREQ-2025-0001‚Äù)
  fecha               DateTime               @default(now()) //fecha de creacion          // cu√°ndo se gener√≥
  sucursalId          Int
  sucursal            Sucursal               @relation(fields: [sucursalId], references: [id])
  usuarioId           Int
  usuario             Usuario                @relation(fields: [usuarioId], references: [id])
  estado              RequisicionEstado      @default(PENDIENTE) // PENDIENTE, ENVIADA, COMPLETADA‚Ä¶
  observaciones       String? // notas adicionales
  totalLineas         Int                    @default(0) // n√∫mero de l√≠neas (se puede calcular en un hook)
  createdAt           DateTime               @default(now())
  updatedAt           DateTime               @updatedAt
  lineas              RequisicionLinea[] // relaci√≥n 1-N
  //nuevas props
  totalRequisicion    Float?
  fechaRecepcion      DateTime?
  esIngresoAutomatico Boolean                @default(false)
  ingresadaAStock     Boolean                @default(false)
  //registro de recibidos
  recepciones         RequisicionRecepcion[]
  movimientoStock     HistorialStock[]
  compra              Compra?                @relation
}

model RequisicionLinea {
  id               Int         @id @default(autoincrement())
  requisicionId    Int
  requisicion      Requisicion @relation(fields: [requisicionId], references: [id], onDelete: Cascade)
  productoId       Int
  producto         Producto    @relation(fields: [productoId], references: [id])
  cantidadActual   Int
  stockMinimo      Int
  cantidadSugerida Int
  precioUnitario   Float? // cuando puedas: Decimal

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  fechaExpiracion   DateTime?
  cantidadRecibida  Int?
  ingresadaAStock   Boolean                     @default(false)
  recepcionesLineas RequisicionRecepcionLinea[]
  compraDetalles    CompraDetalle[]             @relation("DetalleRequisicionCompra")
  // NUEVO: relaci√≥n a presentaci√≥n (todo en una sola l√≠nea)
  presentacionId    Int?
  presentacion      ProductoPresentacion?       @relation("RequisicionLineaToPresentacion", fields: [presentacionId], references: [id], onDelete: SetNull)

  // Los @@ van al final del modelo
  @@index([requisicionId])
}

model RequisicionRecepcion {
  id                     Int                         @id @default(autoincrement())
  requisicionId          Int
  requisicion            Requisicion                 @relation(fields: [requisicionId], references: [id], onDelete: Cascade)
  fechaRecepcion         DateTime                    @default(now())
  usuarioId              Int // usuario que confirma la recepci√≥n
  usuario                Usuario                     @relation(fields: [usuarioId], references: [id])
  observaciones          String? // notas o comentarios sobre la recepci√≥n
  createdAt              DateTime                    @default(now())
  updatedAt              DateTime                    @updatedAt
  lineas                 RequisicionRecepcionLinea[]
  //relacion con stock:
  stockLotes             Stock[]                     @relation("StockRecepcion")
  stockPresentacionLotes StockPresentacion[]         @relation("StockPresentacionRecepcion")
  // Back-rel: prorrateos aplicados a esta recepci√≥n de requisici√≥n
  prorrateos             Prorrateo[]                 @relation("ReqRecepcionToProrrateos")

  // Back-rel: movimientos de costo asociado apuntando a esta recepci√≥n de requisici√≥n
  movimientosCostosAsociados MovimientoFinanciero[] @relation("MF_to_ReqRecepcion")
}

model RequisicionRecepcionLinea {
  id                     Int                  @id @default(autoincrement())
  requisicionRecepcionId Int
  requisicionRecepcion   RequisicionRecepcion @relation(fields: [requisicionRecepcionId], references: [id], onDelete: Cascade)
  requisicionLineaId     Int // referencia a la l√≠nea original para trazabilidad
  requisicionLinea       RequisicionLinea     @relation(fields: [requisicionLineaId], references: [id], onDelete: Cascade)
  productoId             Int
  producto               Producto             @relation(fields: [productoId], references: [id])
  cantidadSolicitada     Int // cantidad solicitada en la requisici√≥n original (puedes replicar o calcular)
  cantidadRecibida       Int // cantidad realmente recibida y agregada a stock
  ingresadaAStock        Boolean              @default(true) // indica si se ingres√≥ o no el stock

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum RequisicionEstado {
  BORRADOR // a√∫n no se ha generado formalmente
  PENDIENTE // creada y a la espera de aprobar/env√≠o
  APROBADA // validada internamente y lista para enviar a compras
  ENVIADA // ya fue enviada al √°rea de compras/proveedor
  RECIBIDA // confirmada la recepci√≥n parcial o total de los productos
  COMPLETADA // todas las l√≠neas recibidas y la requisici√≥n cerrada
  CANCELADA // anulada por alg√∫n motivo
  ENVIADA_COMPRAS
}

// --- Compras ---

model CompraDetalle {
  id                 Int               @id @default(autoincrement())
  cantidad           Int
  costoUnitario      Float
  productoId         Int?
  producto           Producto?         @relation(fields: [productoId], references: [id])
  compraId           Int
  compra             Compra            @relation(fields: [compraId], references: [id], onDelete: Cascade)
  // relaci√≥n opcional a la l√≠nea de requisici√≥n
  requisicionLineaId Int?
  requisicionLinea   RequisicionLinea? @relation("DetalleRequisicionCompra", fields: [requisicionLineaId], references: [id], onDelete: Cascade)

  fechaVencimiento DateTime? // viene de RequisicionLinea o Pedido

  creadoEn          DateTime               @default(now())
  actualizadoEn     DateTime               @updatedAt
  // relaci√≥n a presentaci√≥n (NOMBRADA)
  presentacionId    Int?
  presentacion      ProductoPresentacion?  @relation("CompraDetalleToPresentacion", fields: [presentacionId], references: [id], onDelete: SetNull)
  //NUEVOS
  recepcionesLineas CompraRecepcionLinea[]

  lineasDocumento CxPDocumentoLinea[] @relation("DocumentoLineaToCompraDetalle")
  // Back-rel: prorrateos aplicados a esta l√≠nea espec√≠fica
  prorrateos      Prorrateo[]         @relation("CompraDetalleToProrrateos")

  // Back-rel: movimientos de costo asociado apuntando a esta l√≠nea
  movimientosCostosAsociados MovimientoFinanciero[] @relation("MF_to_CompraDetalle")
}

enum EstadoCompra {
  RECIBIDO
  CANCELADO
  RECIBIDO_PARCIAL
  ESPERANDO_ENTREGA // <‚Äî lo dejamos en el enum
}

enum OrigenCompra {
  DIRECTA
  REQUISICION
  PEDIDO
}

model Compra {
  id            Int             @id @default(autoincrement())
  sucursalId    Int?
  sucursal      Sucursal?       @relation(fields: [sucursalId], references: [id], onDelete: Cascade)
  fecha         DateTime        @default(now())
  total         Float
  detalles      CompraDetalle[]
  estado        EstadoCompra    @default(ESPERANDO_ENTREGA) // TEMPORAL, no usar a√∫n el valor nuevo
  requisicionId Int?            @unique
  requisicion   Requisicion?    @relation(fields: [requisicionId], references: [id], onDelete: Cascade)

  ingresadaAStock           Boolean @default(false)
  cantidadRecibidaAcumulada Int     @default(0)

  proveedorId Int?
  proveedor   Proveedor? @relation(fields: [proveedorId], references: [id], onDelete: SetNull)
  usuarioId   Int
  usuario     Usuario    @relation(fields: [usuarioId], references: [id])

  pedido Pedido? @relation("PedidoACompra")

  facturaNumero String? // p. ej. ‚ÄúF001-000123‚Äù
  facturaFecha  DateTime? // si quieres guardar la fecha de emisi√≥n
  conFactura    Boolean      @default(false) // si solo te interesa saber si viene con factura
  origen        OrigenCompra @default(DIRECTA) // üëà nuevo campo

  //NUEVOS
  recepciones   CompraRecepcion[] @relation("CompraToRecepciones")
  cxpDocumentos CxPDocumento[]    @relation("CompraToCxPDocumentos")

  // Back-rel: prorrateos aplicados a esta compra (cabecera)
  prorrateos Prorrateo[] @relation("CompraToProrrateos")

  // Back-rel: movimientos de costo asociado apuntando a la compra
  movimientosCostosAsociados MovimientoFinanciero[] @relation("MF_to_Compra")

  creadoEn      DateTime @default(now())
  actualizadoEn DateTime @updatedAt
}

// --- Pedidos ---
/// Define los posibles estados de un pedido de cliente
enum PedidoEstado {
  PENDIENTE // reci√©n creado, a la espera de procesar
  ENVIADO_COMPRAS // ya se pas√≥ al m√≥dulo de compras
  RECIBIDO // los art√≠culos llegaron y se ingresaron a stock o se entregaron
  CANCELADO // el cliente anul√≥ o no se complet√≥
}

/// Cabecera del pedido de cliente
enum PedidoPrioridad {
  ALTA
  BAJA
  MEDIA
}

enum TipoPedido {
  INTERNO
  CLIENTE
}

model Pedido {
  id            Int           @id @default(autoincrement())
  folio         String        @unique // p.ej. ‚ÄúPED-2025-0001‚Äù
  fecha         DateTime      @default(now())
  sucursalId    Int // en qu√© tienda/clientes se cre√≥
  sucursal      Sucursal      @relation(fields: [sucursalId], references: [id])
  clienteId     Int? // quien pide
  cliente       Cliente?      @relation(fields: [clienteId], references: [id])
  usuarioId     Int // qui√©n registr√≥ el pedido
  usuario       Usuario       @relation(fields: [usuarioId], references: [id])
  estado        PedidoEstado  @default(PENDIENTE)
  observaciones String? // notas adicionales
  totalLineas   Int           @default(0) // n√∫mero de l√≠neas
  totalPedido   Float? // suma de (cantidad√óprecio) de las l√≠neas
  creadoEn      DateTime      @default(now())
  actualizadoEn DateTime      @updatedAt
  lineas        PedidoLinea[] // detalle de productos
  /// Opcional: si quieres enlazar este pedido a la Compra que generes
  compraId      Int?          @unique
  compra        Compra?       @relation("PedidoACompra", fields: [compraId], references: [id])

  tipo      TipoPedido      @default(INTERNO)
  prioridad PedidoPrioridad @default(MEDIA)
}

/// Cada l√≠nea de un pedido de cliente
model PedidoLinea {
  id       Int    @id @default(autoincrement())
  pedidoId Int
  pedido   Pedido @relation(fields: [pedidoId], references: [id], onDelete: Cascade)

  productoId Int
  producto   Producto @relation(fields: [productoId], references: [id])

  cantidad       Int
  precioUnitario Float
  subtotal       Float    @default(0)
  notas          String?
  creadoEn       DateTime @default(now())
  actualizadoEn  DateTime @updatedAt

  fechaExpiracion DateTime?
  createdAt       DateTime              @default(now())
  updatedAt       DateTime              @updatedAt
  // relaci√≥n a presentaci√≥n (NOMBRADA)
  presentacionId  Int?
  presentacion    ProductoPresentacion? @relation("PedidoLineaToPresentacion", fields: [presentacionId], references: [id], onDelete: SetNull)
}

// ============================================================================
// [S11] TRANSFERENCIAS ENTRE SUCURSALES
// ============================================================================

model TransferenciaProducto {
  id                 Int              @id @default(autoincrement())
  productoId         Int // Producto que se transfiere
  producto           Producto         @relation(fields: [productoId], references: [id], onDelete: Cascade)
  cantidad           Int // Cantidad de producto transferido
  sucursalOrigenId   Int // Sucursal de origen
  sucursalOrigen     Sucursal         @relation("SucursalOrigen", fields: [sucursalOrigenId], references: [id], onDelete: Cascade)
  sucursalDestinoId  Int // Sucursal de destino
  sucursalDestino    Sucursal         @relation("SucursalDestino", fields: [sucursalDestinoId], references: [id], onDelete: Cascade) // NUEVA RELACI√ìN
  fechaTransferencia DateTime         @default(now())
  usuarioEncargadoId Int? // Relaci√≥n con el usuario que hace la transferencia
  usuarioEncargado   Usuario?         @relation(fields: [usuarioEncargadoId], references: [id], onDelete: SetNull)
  //tracker
  movimientoStock    HistorialStock[]
}

model SolicitudTransferenciaProducto {
  id                   Int                          @id @default(autoincrement())
  productoId           Int // ID del producto que se quiere transferir
  producto             Producto                     @relation(fields: [productoId], references: [id], onDelete: Cascade)
  cantidad             Int // Cantidad solicitada
  sucursalOrigenId     Int // Sucursal de origen de la solicitud
  sucursalOrigen       Sucursal                     @relation("SucursalOrigenSolicitud", fields: [sucursalOrigenId], references: [id], onDelete: Cascade)
  sucursalDestinoId    Int // Sucursal de destino de la solicitud
  sucursalDestino      Sucursal                     @relation("SucursalDestinoSolicitud", fields: [sucursalDestinoId], references: [id], onDelete: Cascade)
  usuarioSolicitanteId Int? // Usuario que realiza la solicitud
  usuarioSolicitante   Usuario?                     @relation("UsuarioSolicitante", fields: [usuarioSolicitanteId], references: [id], onDelete: SetNull)
  estado               EstadoSolicitudTransferencia @default(PENDIENTE) // Estado de la solicitud
  fechaSolicitud       DateTime                     @default(now()) // Fecha de la solicitud
  fechaAprobacion      DateTime? // Fecha de aprobaci√≥n o rechazo
  administradorId      Int? // Admin que aprueba/rechaza la solicitud
  administrador        Usuario?                     @relation("AdministradorAprobador", fields: [administradorId], references: [id], onDelete: SetNull)
  // motivoRechazo         String?                                          // Motivo de rechazo, si es rechazado
}

// Enum para el estado de las solicitudes de transferencia
enum EstadoSolicitudTransferencia {
  PENDIENTE
  APROBADO
  RECHAZADO
}

// ============================================================================
// [S12] METAS Y DEP√ìSITOS DE COBRO
// ============================================================================

model MetaUsuario {
  id            Int              @id @default(autoincrement())
  usuarioId     Int // Relaci√≥n con el usuario
  usuario       Usuario          @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  sucursalId    Int // Relaci√≥n con la sucursal donde se establece la meta
  sucursal      Sucursal         @relation(fields: [sucursalId], references: [id], onDelete: Cascade)
  fechaInicio   DateTime         @default(now())
  fechaFin      DateTime // Fin del plazo de la meta
  montoMeta     Float // Monto de ventas objetivo
  montoActual   Float            @default(0) // Ventas acumuladas por el usuario dentro del plazo
  cumplida      Boolean          @default(false) // Indica si la meta fue cumplida
  fechaCumplida DateTime? // Fecha en que se cumpli√≥ la meta, si aplica
  numeroVentas  Float // El numero de ventas hasta el momento
  tituloMeta    String?
  estado        EstadoMetaTienda
  creadoEn      DateTime         @default(now())
  updatedAt     DateTime         @updatedAt
}

enum EstadoMetaTienda {
  CANCELADO
  ABIERTO
  FINALIZADO
  CERRADO
}

model MetaCobros {
  id          Int      @id @default(autoincrement())
  usuarioId   Int // Relaci√≥n con el usuario
  usuario     Usuario  @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  sucursalId  Int // Relaci√≥n con la sucursal donde se establece la meta
  sucursal    Sucursal @relation(fields: [sucursalId], references: [id], onDelete: Cascade)
  fechaCreado DateTime @default(now()) // Fecha en que se cre√≥ la meta

  fechaInicio     DateTime        @default(now())
  fechaFin        DateTime // Fin del plazo de la meta
  montoMeta       Float // Monto objetivo de cobros a alcanzar
  montoActual     Float           @default(0) // Cobros acumulados por el usuario hasta ahora
  cumplida        Boolean         @default(false) // Indica si la meta fue cumplida
  fechaCumplida   DateTime? // Fecha en que se cumpli√≥ la meta, si aplica
  numeroDepositos Int             @default(0) // N√∫mero de dep√≥sitos realizados hasta el momento
  tituloMeta      String?
  estado          EstadoMetaCobro
  DepositoCobro   DepositoCobro[]
}

enum EstadoMetaCobro {
  CANCELADO
  ABIERTO
  FINALIZADO
  CERRADO
}

model DepositoCobro {
  id              Int      @id @default(autoincrement())
  usuarioId       Int // Relaci√≥n con el usuario que hizo el dep√≥sito
  usuario         Usuario  @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  sucursalId      Int // Relaci√≥n con la sucursal del dep√≥sito
  sucursal        Sucursal @relation(fields: [sucursalId], references: [id], onDelete: Cascade)
  numeroBoleta    String // N√∫mero de boleta o comprobante del dep√≥sito
  fechaRegistro   DateTime @default(now()) // Fecha en la que se registr√≥ el dep√≥sito
  montoDepositado Float // Monto del dep√≥sito realizado
  descripcion     String? // Descripci√≥n o nota opcional sobre el dep√≥sito

  metaCobroId Int // Relaci√≥n con MetaCobros
  metaCobro   MetaCobros @relation(fields: [metaCobroId], references: [id], onDelete: Cascade) // Relaci√≥n N:1 con MetaCobros
}

// ============================================================================
// [S13] NOTIFICACIONES
// ============================================================================

model Notificacion {
  id        Int          @id @default(autoincrement())
  // --- CONTENIDO ---
  titulo    String?
  mensaje   String
  categoria NotiCategory @default(OTROS)
  subtipo   String? // libre: 'PRICE_REQUEST', 'CREDIT_AUTH_CREATED', 'LOW_STOCK', etc.
  severidad NotiSeverity @default(INFORMACION)

  // --- CONTEXTO / REFERENCIAS ---
  referenciaTipo String? // 'SolicitudPrecio', 'Transferencia', 'Credito', etc.
  referenciaId   Int?
  sucursalId     Int? // para rastrear/filtrar por sucursal
  // si manejas multi-empresa futuros: companyId Int?

  // --- ACCIONES / UI ---
  route       String? // ej: '/dashboard/solicitudes/123'
  actionLabel String? // ej: 'Ver detalle'
  meta        Json? // payload flexible (IDs, totales, etc.)

  // --- EMISOR/AUDITOR√çA ---
  remitenteId Int?
  remitente   Usuario? @relation("NotiRemitente", fields: [remitenteId], references: [id])

  audiencia NotiAudience @default(USUARIOS) // intenci√≥n (no rompe nada)

  fechaCreacion DateTime  @default(now())
  visibleFrom   DateTime?
  expiresAt     DateTime?
  scheduledAt   DateTime? // si alg√∫n d√≠a programes env√≠os diferidos

  // Estado por usuario (join)
  notificacionesUsuarios NotificacionesUsuarios[]

  // √çNDICES √∫tiles
  @@index([categoria, severidad, fechaCreacion])
  @@index([sucursalId, fechaCreacion])
  @@index([referenciaTipo, referenciaId])
  @@index([fechaCreacion])
}

model NotificacionesUsuarios {
  id             Int          @id @default(autoincrement())
  usuarioId      Int
  usuario        Usuario      @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  notificacionId Int
  notificacion   Notificacion @relation(fields: [notificacionId], references: [id], onDelete: Cascade)

  // Estado por usuario
  leido       Boolean   @default(false)
  leidoEn     DateTime?
  eliminado   Boolean   @default(false) // oculto/dismiss
  dismissedAt DateTime?

  // Ordenado por ‚Äúrecibido‚Äù
  recibidoEn DateTime @default(now())

  pinnedUntil DateTime? // opcional: fijar en top hasta X fecha

  // Idempotencia y performance
  @@unique([usuarioId, notificacionId]) // evita duplicados por carrera
  @@index([usuarioId, eliminado, leido, recibidoEn])
}

// Preferencias por usuario
model NotificationPreference {
  id         Int          @id @default(autoincrement())
  usuarioId  Int
  usuario    Usuario      @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  categoria  NotiCategory
  subtipo    String? // si quieres granular, si no, null = toda la categor√≠a
  sucursalId Int? // preferencias por sucursal (opcional)

  inApp       Boolean      @default(true) // canal in-app
  email       Boolean      @default(false) // canal email (futuro)
  push        Boolean      @default(false) // push m√≥vil (futuro)
  minSeverity NotiSeverity @default(INFORMACION) // umbral m√≠nimo

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([usuarioId, categoria, subtipo, sucursalId])
}

// Nuevos enums
enum NotiCategory {
  VENTAS // Ventas / precios / POS
  INVENTARIO // Stock, vencimiento, transferencias
  CREDITO // Cuentas por cobrar (CxC)
  CUENTAS_POR_PAGAR // CxP (antes "PAGABLES")
  GARANTIA
  REPARACIONES
  COMPRAS
  LOGISTICA
  SISTEMA
  SEGURIDAD
  FACTURACION
  OTROS
}

enum NotiSeverity {
  INFORMACION
  EXITO
  ALERTA // (Si prefieres "ADVERTENCIA", c√°mbialo aqu√≠ y en UI)
  ERROR
  CRITICO
}

enum NotiAudience {
  USUARIOS // notificaciones dirigidas a usuarios espec√≠ficos (join table)
  ROL // intenci√≥n a un rol (igual persistimos por usuario)
  SUCURSAL // intenci√≥n a una sucursal (igual persistimos por usuario)
  GLOBAL // intenci√≥n global/sistema (igual persistimos por usuario o lazy)
}

// ============================================================================
// [S14] UBICACI√ìN (DEPARTAMENTOS / MUNICIPIOS)
// ============================================================================

model Departamento {
  id         Int         @id @default(autoincrement())
  nombre     String      @unique
  municipios Municipio[] // Relaci√≥n con municipios
  clientes   Cliente[] // Relaci√≥n con los clientes
}

model Municipio {
  id             Int          @id @default(autoincrement())
  nombre         String       @unique
  departamentoId Int
  departamento   Departamento @relation(fields: [departamentoId], references: [id], onDelete: Cascade)
  clientes       Cliente[] // Relaci√≥n con los clientes
}

// ============================================================================
// [S15] OTROS (SORTEOS / TICKETS)
// ============================================================================

model TicketSorteo {
  id                Int          @id @default(autoincrement()) // ID √∫nico para cada sorteo
  descripcionSorteo String? // Descripci√≥n del sorteo, incluyendo detalles sobre premios
  // fechaInicio     DateTime?  // Fecha y hora de inicio del sorteo
  // fechaFinal      DateTime?  // Fecha y hora de finalizaci√≥n del sorteo
  creadoEn          DateTime     @default(now()) // Fecha de creaci√≥n del registro
  actualizadoEn     DateTime     @updatedAt // Fecha de la √∫ltima actualizaci√≥n
  estado            EstadoTicket
}

// ==============================NUEVO==============================================
// [S16] RECEPCIONES DE COMPRAS
// ============================================================================
model CompraRecepcion {
  id Int @id @default(autoincrement())

  compraId Int
  compra   Compra @relation("CompraToRecepciones", fields: [compraId], references: [id], onDelete: Cascade)

  fecha     DateTime @default(now())
  usuarioId Int
  usuario   Usuario  @relation("UsuarioToCompraRecepciones", fields: [usuarioId], references: [id])

  observaciones String?
  lineas        CompraRecepcionLinea[]

  createdAt              DateTime            @default(now())
  updatedAt              DateTime            @updatedAt
  //NUEVOS
  stockPresentacionLotes StockPresentacion[] @relation("StockPresentacionToCompraRecepcion")

  documentos  CxPDocumentoRecepcion[] @relation("RecepcionDocumentos")
  pagosOrigen CxPPago[]               @relation("PagoOrigenRecepcion")

  // Back-rel: prorrateos aplicados a esta recepci√≥n
  prorrateos Prorrateo[] @relation("CompraRecepcionToProrrateos")

  // Back-rel: movimientos de costo asociado apuntando a esta recepci√≥n
  movimientosCostosAsociados MovimientoFinanciero[] @relation("MF_to_CompraRecepcion")

  // Back-rel: lotes Stock creados por esta recepci√≥n (NUEVA relaci√≥n expl√≠cita)
  stockLotesCompra Stock[] @relation("StockToCompraRecepcion")

  @@index([compraId, fecha])
}

model CompraRecepcionLinea {
  id                Int             @id @default(autoincrement())
  compraRecepcionId Int
  compraRecepcion   CompraRecepcion @relation(fields: [compraRecepcionId], references: [id], onDelete: Cascade)

  compraDetalleId Int
  compraDetalle   CompraDetalle @relation(fields: [compraDetalleId], references: [id], onDelete: Cascade)

  productoId Int?
  producto   Producto? @relation(fields: [productoId], references: [id])

  presentacionId Int?
  presentacion   ProductoPresentacion? @relation("PresentacionToCompraRecepcionLinea", fields: [presentacionId], references: [id], onDelete: SetNull)

  cantidadRecibida Int
  fechaExpiracion  DateTime?

  stockId Int?    @unique
  stock   Stock?  @relation(fields: [stockId], references: [id], onDelete: SetNull)
  // === UNO-A-UNO con StockPresentacion ===
  stockPresentacionId Int?               @unique
  stockPresentacion   StockPresentacion? @relation("LineaToStockPresentacion", fields: [stockPresentacionId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([compraDetalleId])
}

// ============================================================================
// [S17] COMPRAS A PAGAR
// ============================================================================
enum CxPEstado {
  PENDIENTE
  PARCIAL
  PAGADO
  ANULADO
}

enum CuotaEstado {
  PENDIENTE
  PARCIAL
  PAGADA
  VENCIDA
}

model CondicionPago {
  id              Int           @id @default(autoincrement())
  nombre          String
  diasCredito     Int?
  cantidadCuotas  Int?
  diasEntreCuotas Int?
  interes         Decimal?      @db.Decimal(5, 2)
  tipoInteres     InteresTipo   @default(NONE)
  modoGeneracion  PlanCuotaModo @default(IGUALES)

  // ‚Üê‚Üí CxPDocumento (N:1)  [Relaci√≥n nombrada]
  cxpDocumentos CxPDocumento[] @relation("CondicionPagoToCxPDocumentos")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model CxPDocumento {
  id Int @id @default(autoincrement())

  proveedorId Int
  proveedor   Proveedor @relation("ProveedorToCxPDocumentos", fields: [proveedorId], references: [id], onDelete: Cascade)

  compraId Int?
  compra   Compra? @relation("CompraToCxPDocumentos", fields: [compraId], references: [id], onDelete: SetNull)

  usuarioId Int
  usuario   Usuario @relation("CxPDocumentoCreadoPor", fields: [usuarioId], references: [id], onDelete: Cascade)

  folioProveedor   String?
  fechaEmision     DateTime  @default(now())
  fechaVencimiento DateTime?

  montoOriginal  Decimal @db.Decimal(14, 2)
  saldoPendiente Decimal @db.Decimal(14, 2)
  interesTotal   Decimal @default(0) @db.Decimal(14, 2)

  estado CxPEstado @default(PENDIENTE)

  condicionPagoId Int?
  condicionPago   CondicionPago? @relation("CondicionPagoToCxPDocumentos", fields: [condicionPagoId], references: [id], onDelete: SetNull)

  // ‚Üê‚Üí CxPCuota (1:N)  [Relaci√≥n nombrada para consistencia]
  cuotas CxPCuota[] @relation("DocumentoToCuotas")

  // ‚Üê‚Üí CxPPago (1:N)
  pagos CxPPago[] @relation("DocumentoToPagos")

  // ‚Üê‚Üí CxPDocumentoRecepcion (1:N con tabla puente)
  recepciones CxPDocumentoRecepcion[] @relation("DocumentoRecepciones")

  // ‚Üê‚Üí CxPDocumentoLinea (1:N)
  lineas CxPDocumentoLinea[] @relation("DocumentoToLineas")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([proveedorId, folioProveedor])
  @@index([proveedorId, estado])
  @@index([compraId])
}

model CxPDocumentoRecepcion {
  documentoId Int
  documento   CxPDocumento @relation("DocumentoRecepciones", fields: [documentoId], references: [id], onDelete: Cascade)

  recepcionId Int
  recepcion   CompraRecepcion @relation("RecepcionDocumentos", fields: [recepcionId], references: [id], onDelete: Cascade)

  // Valor de la recepci√≥n que esta factura respalda (opcional)
  montoAsociado Decimal? @db.Decimal(14, 2)

  @@id([documentoId, recepcionId])
  @@index([recepcionId])
}

model CxPCuota {
  id               Int          @id @default(autoincrement())
  documentoId      Int
  documento        CxPDocumento @relation("DocumentoToCuotas", fields: [documentoId], references: [id], onDelete: Cascade)
  numero           Int
  fechaVencimiento DateTime
  monto            Decimal      @db.Decimal(14, 2)
  saldo            Decimal      @db.Decimal(14, 2)
  estado           CuotaEstado  @default(PENDIENTE)
  pagadaEn         DateTime?

  // ‚Üê‚Üí CxPPagoCuota (1:N)
  pagos CxPPagoCuota[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([documentoId, numero])
  @@index([estado, fechaVencimiento])
}

model CxPPago {
  id          Int          @id @default(autoincrement())
  documentoId Int
  documento   CxPDocumento @relation("DocumentoToPagos", fields: [documentoId], references: [id], onDelete: Cascade)

  registradoPorId Int
  registradoPor   Usuario @relation("CxPPagoRegistradoPor", fields: [registradoPorId], references: [id], onDelete: Cascade)

  fechaPago     DateTime   @default(now())
  monto         Decimal    @db.Decimal(14, 2)
  metodoPago    MetodoPago
  referencia    String?
  observaciones String?

  // Enlace a Caja/Banco (1‚Äì1)
  movimientoFinancieroId Int?                  @unique
  movimientoFinanciero   MovimientoFinanciero? @relation("CxPPagoToMovimiento", fields: [movimientoFinancieroId], references: [id], onDelete: SetNull)

  // ‚Üê‚Üí CxPPagoCuota (1:N)
  cuotas CxPPagoCuota[]

  // Trazabilidad: pago originado al cerrar una recepci√≥n (opcional)
  compraRecepcionId Int?
  compraRecepcion   CompraRecepcion? @relation("PagoOrigenRecepcion", fields: [compraRecepcionId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([documentoId, fechaPago])
}

model CxPDocumentoLinea {
  id Int @id @default(autoincrement())

  // ‚Üê‚Üí CxPDocumento (N:1)
  documentoId Int
  documento   CxPDocumento @relation("DocumentoToLineas", fields: [documentoId], references: [id], onDelete: Cascade)

  // Opcional: match con la l√≠nea de compra
  compraDetalleId Int?
  compraDetalle   CompraDetalle? @relation("DocumentoLineaToCompraDetalle", fields: [compraDetalleId], references: [id], onDelete: SetNull)

  // Opcional: referencia a la presentaci√≥n
  presentacionId Int?
  presentacion   ProductoPresentacion? @relation("DocumentoLineaToPresentacion", fields: [presentacionId], references: [id], onDelete: SetNull)

  descripcion   String?
  cantidad      Int?
  costoUnitario Decimal? @db.Decimal(12, 4)
  subtotal      Decimal  @db.Decimal(14, 2)
}

model CxPPagoCuota {
  pagoId Int
  pago   CxPPago @relation(fields: [pagoId], references: [id], onDelete: Cascade)

  cuotaId Int
  cuota   CxPCuota @relation(fields: [cuotaId], references: [id], onDelete: Cascade)

  monto Decimal @db.Decimal(14, 2)

  @@id([pagoId, cuotaId])
}

//TICKET
enum EstadoTicket {
  ACTIVO // El sorteo est√° en curso
  INACTIVO // El sorteo ha finalizado
}

// ============================================================================
// [S18] APROVACION CREDITO VENTA
// ============================================================================
model SolicitudCreditoVenta {
  id Int @id @default(autoincrement())

  // Contexto de la venta/cliente/sucursal
  sucursalId Int
  sucursal   Sucursal @relation("SucursalToSolicitudCreditoVenta", fields: [sucursalId], references: [id], onDelete: Cascade)

  clienteId Int?
  cliente   Cliente? @relation("ClienteToSolicitudCreditoVenta", fields: [clienteId], references: [id], onDelete: SetNull)

  // Snapshot de datos del cliente final (si no est√° registrado)
  nombreCliente    String? //no usamos de momento
  telefonoCliente  String? //no usamos de momento
  direccionCliente String? //no usamos de momento

  // Propuesta econ√≥mica
  totalPropuesto          Float
  cuotaInicialPropuesta   Float         @default(0)
  cuotasTotalesPropuestas Int
  interesTipo             InteresTipo   @default(NONE)
  interesPorcentaje       Int           @default(0) // p.ej. 15 => 15%
  planCuotaModo           PlanCuotaModo @default(IGUALES)
  diasEntrePagos          Int           @default(30)
  fechaPrimeraCuota       DateTime?

  comentario    String?
  garantiaMeses Int     @default(0) //no usamos de momento
  testigos      Json? //no usamos de momento

  // Flujo de aprobaci√≥n (mismo patr√≥n que SolicitudPrecio)
  estado          EstadoSolicitud @default(PENDIENTE)
  solicitadoPorId Int?
  solicitadoPor   Usuario?        @relation("CreditoSolicitadoPor", fields: [solicitadoPorId], references: [id], onDelete: SetNull)

  aprobadoPorId Int?
  aprobadoPor   Usuario? @relation("CreditoAprobadoPor", fields: [aprobadoPorId], references: [id], onDelete: SetNull)

  fechaSolicitud DateTime  @default(now())
  fechaRespuesta DateTime?
  motivoRechazo  String?

  // En caso de aprobaci√≥n, se liga a la Venta creada
  ventaId Int?   @unique
  venta   Venta? @relation("SolicitudCreditoVentaToVenta", fields: [ventaId], references: [id], onDelete: SetNull)

  //lineas cuotas custom desde UI
  cuotasPropuestas SolicitudCreditoVentaCuota[] // <‚Äî NUEVA relaci√≥n

  // L√≠neas e historial  
  lineas    SolicitudCreditoVentaLinea[]
  historial SolicitudCreditoVentaHistorial[]

  creadoEn      DateTime @default(now())
  actualizadoEn DateTime @updatedAt

  @@index([estado, sucursalId, fechaSolicitud])
  @@index([solicitadoPorId])
}

model SolicitudCreditoVentaCuota {
  id          Int                   @id @default(autoincrement())
  solicitudId Int
  solicitud   SolicitudCreditoVenta @relation(fields: [solicitudId], references: [id], onDelete: Cascade)

  numero   Int // 0 = enganche si aplica
  fecha    DateTime
  monto    Float // monto total de esa cuota
  etiqueta TipoCuotaPropuesta   @default(NORMAL)
  origen   OrigenCuotaPropuesta @default(AUTO)
  esManual Boolean              @default(false) // si la UI la edit√≥

  // opcionales por si quieres mostrar desglose:
  montoCapital Float?
  montoInteres Float?

  creadoEn      DateTime @default(now())
  actualizadoEn DateTime @updatedAt

  @@unique([solicitudId, numero])
  @@index([solicitudId, fecha])
}

model SolicitudCreditoVentaLinea {
  id          Int                   @id @default(autoincrement())
  solicitudId Int
  solicitud   SolicitudCreditoVenta @relation(fields: [solicitudId], references: [id], onDelete: Cascade)

  productoId Int?
  producto   Producto? @relation("SolicitudCreditoLineaToProducto", fields: [productoId], references: [id], onDelete: SetNull)

  presentacionId Int?
  presentacion   ProductoPresentacion? @relation("SolicitudCreditoLineaToPresentacion", fields: [presentacionId], references: [id], onDelete: SetNull)

  // Cantidad / precio
  cantidad       Int
  precioUnitario Float // precio aplicado a la propuesta

  precioSeleccionadoId Int
  precioSeleccionado   PrecioProducto @relation("PrecioSeleccionadoEnSolicitudLinea", fields: [precioSeleccionadoId], references: [id], onDelete: Restrict)

  precioListaRef Float? // opcional: precio de lista al momento (auditor√≠a)
  descuento      Float? // opcional por l√≠nea
  subtotal       Float

  // Snapshots opcionales (por si luego cambian nombres/c√≥digos)
  nombreProductoSnapshot     String? //no usamos de momento
  presentacionNombreSnapshot String? //no usamos de momento
  codigoBarrasSnapshot       String? //no usamos de momento

  creadoEn      DateTime @default(now())
  actualizadoEn DateTime @updatedAt

  @@index([solicitudId])
}

enum AccionSolicitudCredito {
  CREADA
  EDITADA
  APROBADA
  RECHAZADA
  CANCELADA
}

model SolicitudCreditoVentaHistorial {
  id          Int                   @id @default(autoincrement())
  solicitudId Int
  solicitud   SolicitudCreditoVenta @relation(fields: [solicitudId], references: [id], onDelete: Cascade)

  accion     AccionSolicitudCredito
  comentario String?
  actorId    Int?
  actor      Usuario?               @relation("ActorSolicitudCredito", fields: [actorId], references: [id], onDelete: SetNull)

  fecha DateTime @default(now())

  @@index([solicitudId, fecha])
}

enum TipoCuotaPropuesta {
  NORMAL
  ENGANCHE
}

enum OrigenCuotaPropuesta {
  AUTO
  MANUAL
}

// ============================================================================
// [s19] CLIENTES Y VENTAS (incluye Garant√≠as y Ventas a Cuotas)
// ============================================================================

model VentaCuota {
  id         Int      @id @default(autoincrement())
  clienteId  Int
  cliente    Cliente  @relation(fields: [clienteId], references: [id], onDelete: Cascade)
  usuarioId  Int
  usuario    Usuario  @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  sucursalId Int
  sucursal   Sucursal @relation(fields: [sucursalId], references: [id], onDelete: Cascade)

  // Mantenemos tus campos:
  totalVenta           Float
  cuotaInicial         Float
  cuotasTotales        Int
  fechaInicio          DateTime    @default(now())
  estado               EstadoCuota @default(ACTIVA)
  cuotas               Cuota[]
  creadoEn             DateTime    @default(now())
  actualizadoEn        DateTime    @updatedAt
  dpi                  String?
  testigos             Json
  fechaContrato        DateTime    @default(now())
  montoVenta           Float
  garantiaMeses        Int
  totalPagado          Float       @default(0)
  diasEntrePagos       Int         @default(0)
  interes              Int         @default(0)
  comentario           String?
  ventaId              Int?        @unique
  venta                Venta?      @relation(fields: [ventaId], references: [id], onDelete: Cascade)
  montoTotalConInteres Float?

  // ======= NUEVO: parametrizaci√≥n del plan =======
  frecuenciaPago   FrecuenciaPago @default(MENSUAL) // NEW
  planCuotaModo    PlanCuotaModo  @default(IGUALES) // NEW
  interesTipo      InteresTipo    @default(NONE) // NEW
  diasGracia       Int            @default(0) // NEW
  moraDiaria       Float          @default(0) // NEW (fija por d√≠a; si usas % puedes guardarlo aqu√≠ tambi√©n)
  fechaProximoPago DateTime? // NEW
  numeroCredito    String?        @unique // NEW (c√≥digo legible opcional)

  historial VentaCuotaHistorial[] @relation("Credito_Historial") // <‚Äî backref
  abonos    AbonoCredito[]        @relation("Credito_Abonos") // <‚Äî backref

  responsableCobroId Int?
  responsableCobro   Usuario?  @relation("ResponsableCobroCredito", fields: [responsableCobroId], references: [id], onDelete: SetNull)

  @@index([responsableCobroId])                   // ‚úÖ √≠ndice √∫til para filtros/cron
  // ======= √çndices √∫tiles =======
  @@index([estado, sucursalId, fechaInicio])
}

model Cuota {
  id             Int        @id @default(autoincrement())
  ventaCuotaId   Int
  ventaCuota     VentaCuota @relation(fields: [ventaCuotaId], references: [id], onDelete: Cascade)
  // Orden y montos programados:
  numero         Int // NEW: 1..N
  monto          Float
  montoEsperado  Float? // lo puedes unificar o mantener como referencia
  montoCapital   Float? // NEW: si quieres desglose programado
  montoInteres   Float? // NEW: si quieres desglose programado
  // Seguimiento de pago:
  montoPagado    Float      @default(0) // NEW: r√°pido para queries
  saldoPendiente Float? // NEW: si prefieres persistir (o calc on-the-fly)
  moraAcumulada  Float      @default(0) // NEW

  fechaUltimoCalculoMora DateTime?

  fechaVencimiento DateTime?
  fechaPago        DateTime?
  estado           EstadoPago @default(PENDIENTE)

  usuarioId Int?
  usuario   Usuario? @relation(fields: [usuarioId], references: [id], onDelete: SetNull)

  comentario    String?
  creadoEn      DateTime     @default(now())
  actualizadoEn DateTime     @updatedAt
  abonos        AbonoCuota[] @relation("Cuota_Abonos") // <‚Äî backref

  @@unique([ventaCuotaId, numero]) // NEW: cada cuota ordenada √∫nica
  @@index([ventaCuotaId, estado, fechaVencimiento]) // NEW
  @@index([fechaVencimiento]) // NEW
}

model AbonoCredito {
  id           Int        @id @default(autoincrement())
  ventaCuotaId Int
  ventaCuota   VentaCuota @relation("Credito_Abonos", fields: [ventaCuotaId], references: [id], onDelete: Cascade)

  sucursalId Int
  sucursal   Sucursal @relation("Sucursal_AbonosCredito", fields: [sucursalId], references: [id], onDelete: Cascade)

  registroCajaId Int?
  registroCaja   RegistroCaja? @relation("Caja_AbonosCredito", fields: [registroCajaId], references: [id], onDelete: SetNull)

  usuarioId Int
  usuario   Usuario @relation("Usuario_AbonosCredito", fields: [usuarioId], references: [id], onDelete: Cascade)

  metodoPago     MetodoPago
  referenciaPago String?
  fechaAbono     DateTime   @default(now())

  montoTotal Float

  detalles AbonoCuota[]

  creadoEn      DateTime @default(now())
  actualizadoEn DateTime @updatedAt

  @@index([ventaCuotaId, fechaAbono])
  @@index([sucursalId, fechaAbono])
}

model AbonoCuota {
  id      Int          @id @default(autoincrement())
  abonoId Int
  abono   AbonoCredito @relation(fields: [abonoId], references: [id], onDelete: Cascade)

  cuotaId Int
  cuota   Cuota @relation("Cuota_Abonos", fields: [cuotaId], references: [id], onDelete: Cascade)

  // Desglose real aplicado:
  montoCapital Float @default(0)
  montoInteres Float @default(0)
  montoMora    Float @default(0)
  montoTotal   Float // redundante pero pr√°ctico en reportes

  @@unique([abonoId, cuotaId])
  @@index([cuotaId])
}

model PlantillaComprobante {
  id            Int       @id @default(autoincrement())
  nombre        String // Nombre o tipo de plantilla (Ej. "Plantilla Cuota Tel√©fonos")
  texto         String // Texto enriquecido de la plantilla (puede ser un string largo o HTML)
  sucursalId    Int?
  sucursal      Sucursal? @relation(fields: [sucursalId], references: [id], onDelete: SetNull)
  creadoEn      DateTime  @default(now())
  actualizadoEn DateTime  @updatedAt
}

model VentaCuotaHistorial {
  id           Int        @id @default(autoincrement())
  ventaCuotaId Int
  ventaCuota   VentaCuota @relation("Credito_Historial", fields: [ventaCuotaId], references: [id], onDelete: Cascade)

  accion     AccionCredito
  comentario String?

  usuarioId Int?
  usuario   Usuario? @relation("Usuario_HistorialCredito", fields: [usuarioId], references: [id], onDelete: SetNull)

  fecha DateTime @default(now())

  @@index([ventaCuotaId, fecha])
}

enum EstadoPago {
  PENDIENTE
  PARCIAL // NEW
  PAGADA
  ATRASADA
}

enum EstadoCuota {
  ACTIVA
  COMPLETADA
  CANCELADA
  EN_MORA // NEW
  REPROGRAMADA // NEW
  PAUSADA // NEW
}

enum AccionCredito {
  CREADO
  CAMBIO_ESTADO
  ABONO
  REPROGRAMADO
  MORA_REGISTRADA
  MORA_CONDONADA
  AJUSTE_MANUAL
}

enum EstadoGarantia {
  RECIBIDO
  DIAGNOSTICO
  EN_REPARACION
  ESPERANDO_PIEZAS
  REPARADO
  REEMPLAZADO
  RECHAZADO_CLIENTE
  CANCELADO
  CERRADO
}

enum FrecuenciaPago {
  SEMANAL
  QUINCENAL
  MENSUAL
}

enum InteresTipo {
  NONE
  SIMPLE
  COMPUESTO
}

enum PlanCuotaModo {
  IGUALES
  PRIMERA_MAYOR
  CRECIENTES
  DECRECIENTES
}

// ============================================================================
// [s20] PRORROTEOS
// ============================================================================
// ============================================================================
// [NUEVO] PRORRATEOS
// ============================================================================

model Prorrateo {
  id Int @id @default(autoincrement())

  sucursalId Int
  sucursal   Sucursal @relation("SucursalToProrrateos", fields: [sucursalId], references: [id], onDelete: Cascade)

  metodo     MetodoProrrateo
  montoTotal Float
  // √Åmbitos opcionales (uno por registro)
  compraId Int?
  compra   Compra? @relation("CompraToProrrateos", fields: [compraId], references: [id], onDelete: Cascade)

  compraRecepcionId Int?
  compraRecepcion   CompraRecepcion? @relation("CompraRecepcionToProrrateos", fields: [compraRecepcionId], references: [id], onDelete: Cascade)

  compraDetalleId Int?
  compraDetalle   CompraDetalle? @relation("CompraDetalleToProrrateos", fields: [compraDetalleId], references: [id], onDelete: Cascade)

  requisicionRecepcionId Int?
  requisicionRecepcion   RequisicionRecepcion? @relation("ReqRecepcionToProrrateos", fields: [requisicionRecepcionId], references: [id], onDelete: Cascade)

  entregaStockId Int?
  entregaStock   EntregaStock? @relation("EntregaStockToProrrateos", fields: [entregaStockId], references: [id], onDelete: Cascade)

  // Idempotencia por MF (1:1)
  movimientoFinancieroId Int?
  movimientoFinanciero   MovimientoFinanciero? @relation("MFToProrrateo", fields: [movimientoFinancieroId], references: [id], onDelete: SetNull)

  // Idempotencia por CxP (si lo usas; ver bloque CxP abajo)
  cxpDocumentoLineaId Int?
  // cxpDocumentoLinea  CxPDocumentoLinea? @relation("CxPLineaToProrrateo", fields: [cxpDocumentoLineaId], references: [id], onDelete: SetNull)

  estado     EstadoProrrateo @default(APLICADO)
  comentario String?
  creadoEn   DateTime        @default(now())
  detalles ProrrateoDetalle[]

  @@unique([movimientoFinancieroId])
  @@unique([cxpDocumentoLineaId])
  @@index([sucursalId])
  @@index([compraId])
  @@index([compraRecepcionId])
  @@index([compraDetalleId])
  @@index([requisicionRecepcionId])
  @@index([entregaStockId])
}

model ProrrateoDetalle {
  id Int @id @default(autoincrement())

  prorrateoId Int
  prorrateo   Prorrateo @relation(fields: [prorrateoId], references: [id], onDelete: Cascade)

  stockId Int?
  stock   Stock? @relation("StockToProrrateoDetalles", fields: [stockId], references: [id], onDelete: Cascade)

  stockPresentacionId Int?
  stockPresentacion   StockPresentacion? @relation("StockPresToProrrateoDetalles", fields: [stockPresentacionId], references: [id], onDelete: SetNull)

  cantidadBase  Int?  @default(0)
  valorBase     Float? @default(0)
  montoAsignado Float? @default(0)

  precioCostoAntes Float? @default(0)
  precioCostoDesp  Float? @default(0)

  // NUEVOS (para reconstruir Excel sin recalcular)
  gastoUnitarioBase      Float?  // a_base = G/T (por unidad base)
  costoFacturaUnitario   Float?  // c·µ¢
  gastoUnitarioAplicado  Float?  // a_target = a_base * factor
  costoUnitarioResultante Float? // u·µ¢ = c·µ¢ + a_target
  inversionLinea         Float?  // L·µ¢ = cantidadTarget * u

  existenciasPrevias             Int?
  inversionPrevias               Float?
  nuevasExistencias              Int?
  costoProrrateadoTotalInversion Float?
  costoUnitarioProrrateado       Float?  // promedio ponderado final (lo ‚Äúcore‚Äù)

  creadoEn DateTime @default(now())
  

  @@index([prorrateoId])
  @@index([stockId])
}

enum MetodoProrrateo {
  VALOR
  UNIDADES
  PESO
  VOLUMEN
}

enum EstadoProrrateo {
  APLICADO
  ANULADO
}
